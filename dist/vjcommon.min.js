(function(A,E){typeof exports=="object"&&typeof module<"u"?E(exports,require("vjmap")):typeof define=="function"&&define.amd?define(["exports","vjmap"],E):(A=typeof globalThis<"u"?globalThis:A||self,E(A.vjcommon={},A.vjmap))})(this,function(A,E){"use strict";var jr=Object.defineProperty;var Nr=(A,E,K)=>E in A?jr(A,E,{enumerable:!0,configurable:!0,writable:!0,value:K}):A[E]=K;var L=(A,E,K)=>(Nr(A,typeof E!="symbol"?E+"":E,K),K);const u=(o=>o&&typeof o=="object"&&"default"in o?o:{default:o})(E),Xe=Object.freeze(Object.defineProperty({__proto__:null,get MapApp(){return st},get providerLayers(){return Se},get LayerBase(){return k},get exportDwg(){return it},get setFeatureProperty(){return M},get cancelDraw(){return lt},get drawPoint(){return ut},get drawLineSting(){return ct},get drawPolygon(){return dt},get drawFillExrusion(){return ft},get polygonToPolyline(){return te},get drawCircle(){return ht},get drawRectangle(){return gt},get drawSlantRectangle(){return yt},get selectRotate(){return mt},get toBezierCurve(){return pt},get drawEllipseFill(){return At},get drawEllipseEdge(){return wt},get drawEllipseFillArc(){return bt},get drawEllipseArc(){return Lt},get getGeoJsonBounds(){return Le},get interactiveCreateGeom(){return re},get drawArrow(){return vt},get createLineTypePolyline(){return Dt},get createLineTypeCurve(){return Ct},get createHatch(){return St},get createOutSymbol(){return kt},get drawText(){return xt},get addFeaturesToDraw(){return N},get isTrackFeature(){return $},get setTrackFeatureProperty(){return ze},get getTrackFeatureProperty(){return R},get addExportRefInfoInText(){return ye},get deleteOrModifyCadEntity(){return we},get deleteCadEntity(){return ot},get modifyCadEntity(){return at},get createGeomData(){return j},get loadDataToDraw(){return nt},get CacheDbStorage(){return Ie},get cacheStorage(){return Q},get TsIndexDb(){return G},get initIndexDb(){return ke},get getInstance(){return xe},get switchCadLayers(){return It},get switchVectorLayers(){return Je},get setLayerOpacity(){return Tt},get setLayerToLowest(){return Ft},get queryMapData(){return q},get toProperties(){return V},get ProcessDataToFeatureCollection(){return ue},get requestChangeData(){return W},get convertArrayToGeoJson(){return ce},get evalDataConvert(){return Te},get runMeasureCmd(){return Pt},get addHighLightSourceLayer(){return Ue},get clearHighLightSourceLayer(){return ee},get getHighlightEntities(){return _e},get clearHighlight(){return me},get selectFeatures(){return Ze},get getMapSnapPoints(){return Ae},get createUpdateMapStyleObj(){return Ot},get createUpdateMapStyleRasterObj(){return Qe},get createUpdateMapStyleVectorObj(){return qe},get WmsOverlayMapType(){return Me},get createMapStyleLayerName(){return X},get getWmsMapsBounds(){return Be},get getWmsDirectTileUrl(){return Re},get getWmsAutoWebBaseMapTileUrl(){return Ve},get getWmsAutoCadBaseMapTileUrl(){return je},get getWmsParamTileUrl(){return Ne},get getWmsTileUrl(){return He},get cad2webCoordinate(){return Ge},get web2cadCoordinate(){return tt},get overlay2BaseCoordinate(){return We},get base2OverlayCoordinate(){return rt},get osmProviderTiles(){return et},get tiandituProviderTiles(){return Fe},get gaodeProviderTiles(){return Pe},get loadWebMap(){return Ee},get toMapLayer(){return P},get sleep(){return oe},get execProgram(){return De},get getShardsTileUrl(){return ae},get getTileShards(){return Ce},get isAlphanumeric(){return ne},get isWebBaseMap(){return O},get getEntityObjectId(){return le},get transformGeoJsonData(){return H}},Symbol.toStringTag,{value:"Module"}));function P(o,s){return{layerId:o.layerId,sourceId:o.sourceId,tag:o.tag,type:o.type,before:o.before,visibleOff:o.visibleOff,...s}}function oe(o){return new Promise(s=>setTimeout(s,o!=null?o:100))}async function De(o,s,t,e){const r=Object.getPrototypeOf(async function(){}).constructor;return await new r("vjmap","map","mapApp","context","common",o)(u.default,s,t,e,Xe)}const ae=(o,s)=>{if(!o)return[o];if(s){let c=s.getService();o=o.replace("{serviceUrl}",c.serverUrl),o=o.replace("{accessToken}",c.accessToken)}let e=/{(\d+-\d+)}/g.exec(o);if(!e)return[o];let r=e[0];if(!r)return[o];r=r.replace("{",""),r=r.replace("}","");let i=r.split("-");if(i.length!=2)return[o];let a=+i[0],n=+i[1];if(n<=a)return[o];let l=[];for(let c=a;c<=n;c++)l.push(o.replace(e[0],c+""));return l},Ce=o=>{if(!o)return{tileUrl:o,tileShards:""};let t=/{(\d+-\d+)}/g.exec(o);if(!t)return{tileUrl:o,tileShards:""};let e=t[0];if(!e)return{tileUrl:o,tileShards:""};const r=o.replace(e,"{s}");e=e.replace("{",""),e=e.replace("}","");let i=e.split("-");if(i.length!=2)return{tileUrl:o,tileShards:""};let a=+i[0],n=+i[1];if(n<=a)return{tileUrl:o,tileShards:""};let l=[];for(let c=a;c<=n;c++)l.push(c);return{tileUrl:r,tileShards:l.join(",")}},ne=o=>/^[a-zA-Z0-9]+$/.test(o),O=o=>!(o==""||o=="CAD"||o===void 0),le=o=>{let s="",t=0;for(t=0;t<o.length&&ne(o[t]);t++)s+=o[t];return s},H=(o,s,t,e,r=1,i=0)=>u.default.transform.convert(s,a=>{let n=o.fromLngLat(u.default.geoPoint(a));return n.transform(t,e,r,i),o.toLngLat(n)});class k{constructor(){L(this,"map");L(this,"mapLayer");L(this,"visibleOff")}async addLayer(s,t){this.map=s,this.mapLayer=t}setLayerStyle(s,t,e,r){this.mapLayer=P(r,e),this.removeLayer(s,t),this.addLayer(s,P(r,e))}setVisible(s,t,e){this.visibleOff=e}removeLayer(s,t){}getLayerId(){return this.mapLayer.layerId}onSourceDataChange(s,t,e,r){!this.mapLayer||!this.map||t&&this.mapLayer.sourceId!=t||this.mapLayer.disableTimerUpdate||this.visibleOff!==!0&&(this.removeLayer(s,this.mapLayer.layerId),this.addLayer(s,this.mapLayer))}async loadUrlImage(s){return new Promise((t,e)=>{const r=new Image;r.src=s,r.onload=()=>{t(r)},r.onerror=()=>{e(`load image ${s} error`)}})}evalValue(s,t,e){if(typeof s=="string")try{return new Function("props","map","vjmap",s)(t,e,u.default)}catch{}else{let r={};for(let i in s){let a=s[i];if(typeof a=="string"&&a.indexOf("return ")>=0)try{a=new Function("props","map","vjmap",a)(t,e,u.default)}catch{}r[i]=a}return r}}async createAnimateImages(s,t){var a;let e,r=Object.keys(t).filter(n=>n.indexOf("animateImages_")==0),i={};for(let n of r)i[n.replace("animateImages_","")]=t[n];if(t.animateImagesType=="arrow")e=u.default.createArrowAnimateImages(i);else if(t.animateImagesType=="antpath")e=u.default.createAntPathAnimateImages(i);else if(t.animateImagesType=="customImage"){let n=await this.loadUrlImage(t.customImageUrl),l={...i,draw:(c,h,d,g)=>{g.fillColor&&(c.fillStyle=g.fillColor,c.fillRect(0,0,h,d)),c.drawImage(n,0,0,n.width,n.height,0,d/2-n.height/2,h,n.height)}};e=u.default.createAntPathAnimateImages(l)}else if(t.animateImagesType=="animateImages"){e=[];for(let n=0;n<((a=t.animateImageUrls)==null?void 0:a.length);n++){let l=`image_animate_${t.layerId}_${n}`;s.hasImage(l)&&s.removeImage(l),await s.loadImageEx(l,t.animateImageUrls[n]),e.push(l)}}else if(t.animateImagesType=="imageSprites"){let n=await this.loadUrlImage(t.imageSpriteUrl);e=u.default.createAntPathAnimateImages({fromImage:n,...i})}else e=u.default.createAnimateImages(i);return e}setMarkerOptions(s,t){(t==null?void 0:t.minZoom)!==void 0&&s.setMinZoom(t==null?void 0:t.minZoom),(t==null?void 0:t.maxZoom)!==void 0&&s.setMaxZoom(t==null?void 0:t.maxZoom),(t==null?void 0:t.scaleMaxZoom)!==void 0&&s.setScaleMaxZoom(t==null?void 0:t.scaleMaxZoom),(t==null?void 0:t.height)!==void 0&&s.setHeight(t==null?void 0:t.height),(t==null?void 0:t.removeWhenNoInMapView)!==void 0&&s.setRemoveWhenNoInMapView(t==null?void 0:t.removeWhenNoInMapView,t==null?void 0:t.removeWhenNoInMapViewPadding),(t==null?void 0:t.rotation)!==void 0&&s.setRotation(t==null?void 0:t.rotation),(t==null?void 0:t.animationType)!==void 0&&s.setAnimation(t==null?void 0:t.animationType),(t==null?void 0:t.draggable)!==void 0&&s.setDraggable(t==null?void 0:t.draggable),(t==null?void 0:t.rotationAlignment)!==void 0&&s.setRotationAlignment(t==null?void 0:t.rotationAlignment),(t==null?void 0:t.pitchAlignment)!==void 0&&s.setPitchAlignment(t==null?void 0:t.pitchAlignment)}}class Vt extends k{constructor(){super();L(this,"polyline")}async addLayer(t,e){super.addLayer(t,e),this.polyline=new u.default.Polyline(e),this.polyline.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.polyline.hide():this.polyline.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class jt extends k{constructor(){super();L(this,"polygon")}async addLayer(t,e){super.addLayer(t,e),this.polygon=new u.default.Polygon(e),this.polygon.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.polygon.hide():this.polygon.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Nt extends k{constructor(){super();L(this,"symbol")}async addLayer(t,e){super.addLayer(t,e),this.symbol=new u.default.Symbol(e),this.symbol.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.symbol.hide():this.symbol.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Ht extends k{constructor(){super();L(this,"circle")}async addLayer(t,e){super.addLayer(t,e),this.circle=new u.default.Circle(e),this.circle.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.circle.hide():this.circle.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Gt extends k{constructor(){super();L(this,"fillExtrusion")}async addLayer(t,e){super.addLayer(t,e),this.fillExtrusion=new u.default.FillExtrusion(e),this.fillExtrusion.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.fillExtrusion.hide():this.fillExtrusion.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class Wt extends k{constructor(){super();L(this,"heatmap")}async addLayer(t,e){super.addLayer(t,e),this.heatmap=new u.default.Heatmap(e),this.heatmap.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.heatmap.hide():this.heatmap.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}onSourceDataChange(t,e,r,i){r&&super.onSourceDataChange(t,e,r,i)}}class zt extends k{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){var n,l,c;if(r=this.evalValue(r,e,i),r.customHtml){let h=this.evalValue(r.customHtml,e,i);r.element=h}else if(r.customImage){let h=document.createElement("div");h.className="marker",r.customImage.toLowerCase().indexOf("<svg")==0&&(r.customImage="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(r.customImage)))),h.style.backgroundImage=`url("${r.customImage}")`,h.style.width=((n=r.customImageWidth)!=null?n:40)+"px",h.style.height=((l=r.customImageHeight)!=null?l:40)+"px",h.style.backgroundSize="100%",r.element=h}let a=u.default.createMarker(r);if(a.setLngLat(t).addTo(i),r.animationType&&a.setAnimation(r.animationType),r.popupHtml){let h=new u.default.Popup({offset:(c=r.popupOffset)!=null?c:[0,0],anchor:r.popupAnchor,closeButton:r.closeButton,closeOnClick:r.closeOnClick,closeOnMove:r.closeOnMove,focusAfterOpen:r.focusAfterOpen,className:r.className,maxWidth:r.maxWidth}),d=r.popupHtml,g=this.evalValue("return `"+d+"`",e,i);h.setHTML(g),a.setPopup(h)}this.markers=this.markers||[],this.markers.push(a)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class Ut extends k{constructor(){super();L(this,"popups")}createPopup(t,e,r,i){var c;let a=new u.default.Popup({offset:(c=r.offset)!=null?c:[0,0],anchor:r.anchor,closeButton:r.closeButton,closeOnClick:r.closeOnClick,closeOnMove:r.closeOnMove,focusAfterOpen:r.focusAfterOpen,className:r.className,maxWidth:r.maxWidth}),n=r.html,l=this.evalValue("return `"+n+"`",e,i);a.setHTML(l).setLngLat(t).addTo(i),this.popups=this.popups||[],this.popups.push(a)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createPopup(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createPopup(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.popups)i.getElement().style.display=r?"none":""}removeLayer(t,e){if(!!this.popups){for(let r of this.popups)r.remove();this.popups=[],super.removeLayer(t,e)}}}class _t extends k{constructor(){super();L(this,"animateLine")}async addLayer(t,e){var n;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=await this.createAnimateImages(t,e),a={...e};delete a.layerId,delete a.sourceId,this.animateLine=u.default.createAnimateLineLayer(t,r,{animateImages:i,speed:(n=e.speed)!=null?n:1,...a})}getLayerId(){return this.animateLine.layerId}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.animateLine.stopAnimation(),this.animateLine.polyline.hide()):(this.animateLine.polyline.show(),this.animateLine.startAnimation())}removeLayer(t,e){this.animateLine.remove(),super.removeLayer(t,e)}}class Zt extends k{constructor(){super();L(this,"animateSymbol")}async addLayer(t,e){var n;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=await this.createAnimateImages(t,e),a={...e};delete a.layerId,delete a.sourceId,this.animateSymbol=u.default.createAnimateSymbolLayer(t,r,{animateImages:i,speed:(n=e.speed)!=null?n:1,...a})}getLayerId(){return this.animateSymbol.layerId}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.animateSymbol.stopAnimation(),this.animateSymbol.symbol.hide()):(this.animateSymbol.symbol.show(),this.animateSymbol.startAnimation())}removeLayer(t,e){this.animateSymbol.remove(),super.removeLayer(t,e)}}class Jt extends k{constructor(){super();L(this,"animateFill")}async addLayer(t,e){var n;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=await this.createAnimateImages(t,e),a={...e};delete a.layerId,delete a.sourceId,this.animateFill=u.default.createAnimateFillLayer(t,r,{animateImages:i,speed:(n=e.speed)!=null?n:1,...a})}getLayerId(){return this.animateFill.layerId}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.animateFill.stopAnimation(),this.animateFill.polygon.hide()):(this.animateFill.polygon.show(),this.animateFill.startAnimation())}removeLayer(t,e){this.animateFill.remove(),super.removeLayer(t,e)}}class Yt extends k{constructor(){super();L(this,"sourceId");L(this,"events");this.events=[]}async createCluster(t,e){var h,d,g,f,y;this.sourceId="cluster-points"+u.default.RandomID();let r=t.getSourceData(e.sourceId);t.addSource(this.sourceId,{type:"geojson",data:r,cluster:!0,clusterMaxZoom:(h=e.clusterMaxZoom)!=null?h:10,clusterRadius:(d=e.clusterRadius)!=null?d:60});let i=(g=e.outerColors)!=null?g:[[1e3,"rgba(253, 156, 115, 0.6)"],[100,"rgba(241, 211, 87, 0.6)"],[0,"rgba(181, 226, 140, 0.6)"]];i.forEach((m,w)=>{var p;t.addLayer({id:"point-outer-cluster-"+this.sourceId+w,type:"circle",source:this.sourceId,paint:{"circle-color":m[1],"circle-radius":(p=e.outerCircleRadius)!=null?p:20},filter:w===0?[">=","point_count",m[0]]:["all",[">=","point_count",m[0]],["<","point_count",i[w-1][0]]]})});let a=(f=e.innerColors)!=null?f:[[1e3,"rgba(241, 128, 23, 0.6)"],[100,"rgba(240, 194, 12, 0.6)"],[0,"rgba(110, 204, 57, 0.6)"]];a.forEach((m,w)=>{var p;t.addLayer({id:"point-inner-cluster-"+this.sourceId+w,type:"circle",source:this.sourceId,paint:{"circle-color":m[1],"circle-radius":(p=e.innerCircleRadius)!=null?p:15},filter:w===0?[">=","point_count",m[0]]:["all",[">=","point_count",m[0]],["<","point_count",a[w-1][0]]]})}),t.addLayer({id:"cluster-count"+this.sourceId,type:"symbol",source:this.sourceId,filter:["has","point_count"],layout:{"text-field":"{point_count_abbreviated}","text-font":["simsun"],"text-size":(y=e.clusterTextSize)!=null?y:12}}),t.addLayer({...t.properties({...e}),id:"unclustered-point"+this.sourceId,type:"symbol",source:this.sourceId,filter:["!",["has","point_count"]]});for(let m=0;m<i.length;m++){let w="point-outer-cluster-"+this.sourceId+m;const p=C=>{var x;let v=t.queryRenderedFeatures(C.point,{layers:[w]}),S=v[0].properties.cluster_id;(x=t.getSource(this.sourceId))==null||x.getClusterExpansionZoom(S,(T,I)=>{T||t.easeTo({center:v[0].geometry.coordinates,zoom:I})})};t.on("click",w,p),this.events.push(["click",w,p]);const b=C=>{t.getCanvas().style.cursor="pointer"};t.on("mouseenter",w,b),this.events.push(["mouseenter",w,b]);const D=C=>{t.getCanvas().style.cursor=""};t.on("mouseleave",w,D),this.events.push(["mouseleave",w,D])}const n=m=>{var p;let w=m.features[0].geometry.coordinates.slice();if(m.features[0].properties.index,e.popupHtml){let b=new u.default.Popup({offset:(p=e.popupOffset)!=null?p:[0,0],anchor:e.popupAnchor,closeButton:e.closeButton,closeOnClick:e.closeOnClick,closeOnMove:e.closeOnMove,focusAfterOpen:e.focusAfterOpen,className:e.className,maxWidth:e.maxWidth});b.setLngLat(w);let D=e.popupHtml,C=this.evalValue("return `"+D+"`",m.features[0].properties,this.map);b.setHTML(C).addTo(t)}};t.on("click","unclustered-point"+this.sourceId,n),this.events.push(["click","unclustered-point"+this.sourceId,n]);const l=()=>{t.getCanvas().style.cursor="pointer"};t.on("mouseenter","unclustered-point"+this.sourceId,l),this.events.push(["mouseenter","unclustered-point"+this.sourceId,l]);const c=()=>{t.getCanvas().style.cursor=""};t.on("mouseleave","unclustered-point"+this.sourceId,c),this.events.push(["mouseleave","unclustered-point"+this.sourceId,c])}async addLayer(t,e){super.addLayer(t,e),this.createCluster(t,e)}setVisible(t,e,r){super.setVisible(t,e,r),r?t.hideSource(this.sourceId):t.showSource(this.sourceId)}removeLayer(t,e){if(this.events){for(let r of this.events)t.off(r[0],r[1],r[1]);this.events=[]}t.removeSourceEx(this.sourceId),super.removeLayer(t,e)}}class Kt extends k{constructor(){super();L(this,"markerCluster");L(this,"popupInfo");this.popupInfo=null}getColor(t,e,r){t=t!=null?t:[[0,"#00FFFF","#00FFFF"],[5,"#F0F","#80FF00"],[10,"#00F","#FFFF00"],[1e3,"#FFF","#FF3D3D"]];for(let i=0;i<t.length;i++)if(e<=t[i][0])return r?t[i][1]:t[i][2];return t.length==0?"#00FFFF":r?t[t.length-1][1]:t[t.length-1][2]}async addLayer(t,e){var c,h,d,g;super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features,a=[];for(let f=0;f<i.length;f++){let y=i[f].geometry;if(y.type=="Point"&&a.push({point:t.fromLngLat(y.coordinates),properties:{...i[f].properties}}),e.isDrawLinePoint){let m=[];y.type=="LineString"?m=y.coordinates:y.type=="Polygon"&&(m=y.coordinates[0]);for(let w of m)a.push({point:t.fromLngLat(w),properties:{...i[f].properties}})}}const n=(f,y)=>{if(y.length<=1){let m={...e};m=this.evalValue(m,f.properties,this.map);let w=new u.default.Marker({...e,color:this.getColor(m.textColors,y.length)}).setLngLat(this.map.toLngLat(f.point));return m.popupHtml&&w.on("click",p=>{var C;this.popupInfo?this.popupInfo.remove():this.popupInfo=new u.default.Popup({offset:(C=m.popupOffset)!=null?C:[0,0],anchor:m.popupAnchor,closeButton:m.closeButton,closeOnClick:m.closeOnClick,closeOnMove:m.closeOnMove,focusAfterOpen:m.focusAfterOpen,className:m.className,maxWidth:m.maxWidth});let b=m.popupHtml,D=this.evalValue("return `"+b+"`",w.clusterMarkersData[0].properties,this.map);this.popupInfo.setHTML(D),this.popupInfo.setLngLat(w.getLngLat()).addTo(this.map)}),w}else{let m=new u.default.Text({text:y.length+"",anchor:"center",offset:[0,0],style:{"background-color":this.getColor(e.textColors,y.length),color:this.getColor(e.textColors,y.length,!0),...e.textStyle}});return m.setLngLat(this.map.toLngLat(f.point)).addTo(this.map),m.on("click",w=>{if(m.clusterMarkersData.length===1)return;let p=m.clusterMarkersData.map(C=>C.point),b=u.default.geoBounds();b.update(p);let D=this.map.toLngLat(b);this.map.fitBounds(D,{padding:40})}),m}},l=(f,y,m)=>{if(m instanceof u.default.Text)if(y.length>1)m.setText(y.length+"");else return m.remove(),n(f,y);else if(y.length>1)return m.remove(),n(f,y)};this.markerCluster=new u.default.MarkerCluster({data:a,createMarker:n,updateMarker:l,allowOverlap:(c=e.allowOverlap)!=null?c:!1,allowOverlapMaxZoom:(h=e.allowOverlapMaxZoom)!=null?h:4,markerWidth:(d=e.markerWidth)!=null?d:28,markerHeight:(g=e.markerHeight)!=null?g:40}),this.markerCluster.addTo(t)}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?this.markerCluster.hide():this.markerCluster.show()}removeLayer(t,e){this.markerCluster.remove(),this.popupInfo&&(this.popupInfo.remove(),this.popupInfo=null),super.removeLayer(t,e)}}class Qt extends k{constructor(){super();L(this,"texts")}createText(t,e,r,i){var c;r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.Text({...r,text:n});if(this.setMarkerOptions(l,r),l.setLngLat(t).addTo(i),r.animationType&&l.setAnimation(r.animationType),r.popupHtml){let h=new u.default.Popup({offset:(c=r.popupOffset)!=null?c:[0,0],anchor:r.popupAnchor,closeButton:r.closeButton,closeOnClick:r.closeOnClick,closeOnMove:r.closeOnMove,focusAfterOpen:r.focusAfterOpen,className:r.className,maxWidth:r.maxWidth}),d=r.popupHtml,g=this.evalValue("return `"+d+"`",e,i);h.setHTML(g),l.setPopup(h)}this.texts=this.texts||[],this.texts.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createText(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createText(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.texts)r?i.hide():i.show()}removeLayer(t,e){if(!!this.texts){for(let r of this.texts)r.remove();this.texts=[],super.removeLayer(t,e)}}}class qt extends k{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.BreathingApertureMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class Xt extends k{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.RotatingApertureMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class $t extends k{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.HaloRingMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class er extends k{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.DiffusedApertureMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class tr extends k{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.RotatingTextBorderMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class rr extends k{constructor(){super();L(this,"markers")}createMarker(t,e,r,i){r=this.evalValue(r,e,i);let a=r.text||"",n=this.evalValue("return `"+a+"`",e,i),l=new u.default.FluorescenceMarker({lngLat:t,text:n},{...r,colors:[r.color1,r.color2],height:r.markerHeight}).createMarker();l.addTo(i),this.setMarkerOptions(l,r),this.markers=this.markers||[],this.markers.push(l)}async addLayer(t,e){super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type=="Point"&&this.createMarker(n.coordinates,i[a].properties,e,t),e.isDrawLinePoint){let l=[];n.type=="LineString"?l=n.coordinates:n.type=="Polygon"&&(l=n.coordinates[0]);for(let c of l)this.createMarker(c,i[a].properties,e,t)}}}setVisible(t,e,r){super.setVisible(t,e,r);for(let i of this.markers)i.setVisible(!r,!0)}removeLayer(t,e){if(!!this.markers){for(let r of this.markers)r.remove();this.markers=[],super.removeLayer(t,e)}}}class sr extends k{constructor(){super();L(this,"polyline")}async addLayer(t,e){super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=[],a=r.features;for(let l=0;l<a.length;l++){let c=a[l].geometry;if(c.type!="LineString")continue;let h=c.coordinates;if(c.coordinates.length>2){const d=u.default.polylineToBezierCurve(t.fromLngLat(c.coordinates).map(g=>[g.x,g.y]));h=u.default.bezierCurveToPolyline(d),i.push({points:t.toLngLat(h),properties:c.properties})}else i.push({points:h,properties:c.properties})}let n={...e};delete n.layerId,delete n.sourceId,this.polyline=new u.default.Polyline({data:i,...n}),this.polyline.addTo(t,e.before)}getLayerId(){return this.polyline.layerId}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?this.polyline.hide():this.polyline.show()}removeLayer(t,e){this.polyline&&this.polyline.remove(),super.removeLayer(t,e)}}class ir extends k{constructor(){super();L(this,"fillExtrusion");L(this,"anim")}async addLayer(t,e){var l,c;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=[],a=r.features;for(let h=0;h<a.length;h++){let d=a[h].geometry,g=[];if(d.type=="LineString")g.push(d.coordinates);else if(d.type=="MultiLineString")g.push(...d.coordinates);else continue;if(e.isBreakLine){let f=[];for(let y of g){for(let m=0;m<y.length-1;m++)f.push([y[m],y[m+1]]);g=f}}for(const f of g){let y=t.fromLngLat(f),m=u.default.polylineMarginToPolygon(y,{offset:(l=e.offsetLine)!=null?l:10});i.push({points:t.toLngLat(m),properties:{...d.properties,path:m}})}}let n={...e};if(delete n.layerId,delete n.sourceId,this.fillExtrusion=new u.default.FillExtrusion({data:i,...n}),this.fillExtrusion.addTo(t,e.before),e.anmiDuration){const h=u.default.cloneDeep(this.fillExtrusion.getData());this.anim=u.default.createAnimation({from:0,to:1,repeatType:(c=e.anmiRepeatType)!=null?c:"reverse",repeat:e.anmiRepeat||1/0,duration:e.anmiDuration*1e3,ease:u.default.linear,onUpdate:d=>{var f;const g=this.fillExtrusion.getData();for(let y=0;y<g.features.length;y++){const m=d,w=h.features[y].properties,p=u.default.interpolatePointsByRatio(w.path,m);if(p.length>1){const b=u.default.polylineMarginToPolygon(p,{offset:(f=e.offsetLine)!=null?f:10}),D=u.default.createPolygonGeoJson(t.toLngLat(b));D.features[0]&&D.features[0].geometry&&(g.features[y].geometry.coordinates=D.features[0].geometry.coordinates)}}this.fillExtrusion.setData(g)}})}}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.fillExtrusion.hide(),this.anim&&this.anim.stop()):(this.fillExtrusion.show(),this.anim&&this.anim.start())}removeLayer(t,e){this.fillExtrusion&&this.fillExtrusion.remove(),this.anim&&(this.anim.stop(),this.anim=null),super.removeLayer(t,e)}}class or extends k{constructor(){super();L(this,"polylineArrows")}async addLayer(t,e){super.addLayer(t,e),this.polylineArrows=this.polylineArrows||[];let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type!="LineString")continue;await t.onLoad(!0);let l=n.coordinates,c=this.evalValue(e,i[a].properties,t);delete c.layerId,delete c.sourceId;let h=new u.default.PolylineArrow({...c,path:l});h.addTo(t,e.before),this.polylineArrows.push(h)}}getLayerId(){return this.polylineArrows.map(t=>t.id)}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){if(super.setVisible(t,e,r),this.polylineArrows&&this.polylineArrows.length)for(let i of this.polylineArrows)r?i.hide():i.show()}removeLayer(t,e){if(this.polylineArrows&&this.polylineArrows.length){for(let r of this.polylineArrows)r.remove();this.polylineArrows=[]}super.removeLayer(t,e)}}class ar extends k{constructor(){super();L(this,"polylineArrows");L(this,"symbolSourcedIds");L(this,"anims")}async addLayer(t,e){super.addLayer(t,e),this.polylineArrows=this.polylineArrows||[],this.symbolSourcedIds=this.symbolSourcedIds||[],this.anims=this.anims||[];let i=t.getSourceData(e.sourceId).features;for(let a=0;a<i.length;a++){let n=i[a].geometry;if(n.type!="LineString")continue;await t.onLoad(!0);let l=n.coordinates,c=this.evalValue(e,i[a].properties,t);delete c.layerId,delete c.sourceId;let h=new u.default.PolylineArrow({...c,path:l});h.addTo(t,e.before),this.polylineArrows.push(h);let d;if(e.iconImage){let y=Object.keys(e).filter(p=>p.indexOf("symbol")==0||p.indexOf("icon")==0||p.indexOf("text")==0),m={};for(let p of y)m[p]=e[p];let w=u.default.RandomID();d="path_animi_source_"+w,t.addGeoJSONSource(d),t.addSymbolLayer("path_animi_layer_"+w,d,{iconRotate:["get","bearing"],iconRotationAlignment:"map",iconAllowOverlap:!0,iconIgnorePlacement:!0,...m}),this.symbolSourcedIds.push(d)}let g=c.fps||10;const f=h.animate(100,g,!0,y=>{},(y,m)=>{if(y!==u.default.FrameAnimationStatus.Run||!d)return;const w=u.default.geoPoint(m.endPnt).angleTo(u.default.geoPoint(m.startPnt)),p=u.default.createPointGeoJson({point:m.endPnt,properties:{...i[a].properties,bearing:u.default.radToDeg(-w)}});t.setData(d,p)});this.anims.push(f)}}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){if(super.setVisible(t,e,r),this.anims&&this.anims.length)for(let i of this.anims)r?i.stop():i.start();if(this.polylineArrows&&this.polylineArrows.length){for(let i of this.polylineArrows)r?i.hide():i.show();for(let i of this.symbolSourcedIds)r?t.hideSource(i):t.showSource(i)}}removeLayer(t,e){if(this.anims&&this.anims.length){for(let r of this.anims)r.stop();this.anims=[]}if(this.polylineArrows&&this.polylineArrows.length){for(let r of this.polylineArrows)r.remove();this.polylineArrows=[]}if(this.symbolSourcedIds&&this.symbolSourcedIds.length){for(let r of this.symbolSourcedIds)t.removeSourceEx(r);this.symbolSourcedIds=[]}super.removeLayer(t,e)}}class nr extends k{constructor(){super();L(this,"line");L(this,"symbol");L(this,"anim")}async addLayer(t,e){var g;super.addLayer(t,e);let i=t.getSourceData(e.sourceId).features,a=[],n=[];for(let f=0;f<i.length;f++){let y=i[f].geometry;if(y.type!="LineString")continue;let m=t.fromLngLat(y.coordinates);e.drawPath&&n.push({points:t.toLngLat(m),properties:{...i[f].properties}});const w=u.default.geoPoint(m[1]).angleTo(u.default.geoPoint(m[0]));a.push({point:t.toLngLat(m[0]),properties:{...i[f].properties,bearing:u.default.radToDeg(-w),path:m}})}if(n.length>0){let f=Object.keys(e).filter(m=>m.indexOf("line")==0),y={};for(let m of f)y[m]=e[m];this.line=new u.default.Polyline({data:n,...y}),this.line.addTo(t)}let l=Object.keys(e).filter(f=>f.indexOf("symbol")==0||f.indexOf("icon")==0||f.indexOf("text")==0),c={};for(let f of l)c[f]=e[f];this.symbol=new u.default.Symbol({data:a,iconAllowOverlap:!0,iconRotationAlignment:"map",...c,iconRotate:["get","bearing"]}),this.symbol.addTo(t,e.before);const h=u.default.cloneDeep(this.symbol.getData());let d=0;this.anim=u.default.createAnimation({from:0,to:1,repeatType:(g=e.anmiRepeatType)!=null?g:"reverse",repeat:e.anmiRepeat||1/0,duration:e.anmiDuration*1e3,ease:u.default.linear,onUpdate:f=>{let y=d>f;d=f;const m=this.symbol.getData();for(let w=0;w<m.features.length;w++){const p=f,b=h.features[w].properties,D=u.default.interpolatePointsByRatio(b.path,p);if(D.length>1){let C=D[D.length-2],v=D[D.length-1],S=0;y?S=u.default.geoPoint(C).angleTo(u.default.geoPoint(v)):S=u.default.geoPoint(v).angleTo(u.default.geoPoint(C)),m.features[w].properties.bearing=u.default.radToDeg(-S);const x=u.default.createPointGeoJson(t.toLngLat(v));x.features[0]&&x.features[0].geometry&&(m.features[w].geometry.coordinates=x.features[0].geometry.coordinates)}}this.symbol.setData(m)}})}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.anim.stop(),this.symbol.hide(),this.line&&this.line.hide()):(this.line&&this.line.show(),this.symbol.show(),this.anim.start())}removeLayer(t,e){this.anim.stop(),this.symbol.remove(),this.line&&this.line.remove(),super.removeLayer(t,e)}}class lr extends k{constructor(){super();L(this,"fillExtrusion");L(this,"anim")}async addLayer(t,e){var l;super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i=[],a=r.features;for(let c=0;c<a.length;c++){let h=a[c].geometry;h.type=="Polygon"&&i.push({points:h.coordinates,properties:{...h.properties}})}let n={...e};if(delete n.layerId,delete n.sourceId,this.fillExtrusion=new u.default.FillExtrusion({data:i,...n,fillExtrusionHeight:["get","height"]}),this.fillExtrusion.addTo(t,e.before),e.anmiDuration){const c=u.default.cloneDeep(this.fillExtrusion.getData()),h=d=>u.default.interpolate([0,1],[{height:0},{height:c.features[d].properties.height||5e5}]);this.anim=u.default.createAnimation({from:0,to:1,repeatType:(l=e.anmiRepeatType)!=null?l:"loop",repeat:e.anmiRepeat||1/0,duration:e.anmiDuration*1e3,onUpdate:d=>{const g=this.fillExtrusion.getData();for(let f=0;f<g.features.length;f++){const y=h(f)(d);g.features[f].properties.height=y.height}this.fillExtrusion.setData(g)}})}}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),r?(this.fillExtrusion.hide(),this.anim&&this.anim.stop()):(this.fillExtrusion.show(),this.anim&&this.anim.start())}removeLayer(t,e){this.fillExtrusion&&this.fillExtrusion.remove(),this.anim&&(this.anim.stop(),this.anim=null),super.removeLayer(t,e)}}class ur extends k{constructor(){super();L(this,"sourceId")}async addLayer(t,e){super.addLayer(t,e);let r=t.getSourceData(e.sourceId),i="geojson_source_"+u.default.RandomID();this.sourceId=i,t.addGeoJSONSource(i,r);let a=Object.keys(e).filter(g=>g.indexOf("fill")==0),n={};for(let g of a)n[g]=e[g];t.addFillLayer(i+"-layer-polygons",i,{source:i,...n,filter:["==",["geometry-type"],"Polygon"]});let l=Object.keys(e).filter(g=>g.indexOf("line")==0),c={};for(let g of l)c[g]=e[g];t.addLineLayer(i+"-layer-lines",i,{source:i,...c,filter:["==",["geometry-type"],"LineString"]});let h=Object.keys(e).filter(g=>g.indexOf("circle")==0),d={};for(let g of h)d[g]=e[g];t.addCircleLayer(i+"-layer-points",i,{source:i,...d,filter:["==",["geometry-type"],"Point"]})}setLayerStyle(t,e,r,i){super.setLayerStyle(t,e,r,i),this.removeLayer(t,e),this.addLayer(t,P(i,r))}setVisible(t,e,r){super.setVisible(t,e,r),this.sourceId&&(r?t.hideSource(this.sourceId):t.showSource(this.sourceId))}removeLayer(t,e){this.sourceId&&(t.removeSourceEx(this.sourceId),this.sourceId=void 0),super.removeLayer(t,e)}}class cr extends k{constructor(){super();L(this,"draw");L(this,"sourceID")}async addLayer(t,e){super.addLayer(t,e),this.sourceID=e.sourceId;let r=t.getSourceData(e.sourceId);const i=u.default.cloneDeep(u.default.Draw.defaultOptions());i.isActionDrawMode=!0,this.draw=new u.default.Draw.Tool(i),t.addControl(this.draw,"top-right"),this.draw.set(r)}setVisible(t,e,r){if(super.setVisible(t,e,r),!!this.draw)if(r)this.draw.set({type:"FeatureCollection",features:[]});else{let i=t.getSourceData(this.sourceID);this.draw.set(i)}}removeLayer(t,e){this.draw&&(this.map.removeControl(this.draw),this.draw=null),super.removeLayer(t,e)}}class dr extends k{constructor(){super()}async addLayer(s,t){super.addLayer(s,t),s.addRasterLayer(t.layerId,t.sourceId,t,t.before)}setVisible(s,t,e){super.setVisible(s,t,e),e?s.hide(t):s.show(t)}removeLayer(s,t){s.removeLayerEx(t),super.removeLayer(s,t)}}class fr extends k{constructor(){super();L(this,"layers")}async addLayer(t,e){super.addLayer(t,e);const r=t.getService().vectorStyle();this.layers=r.layers;for(let i of this.layers)i.source=e.sourceId,i.id=i.id.replace("vector-",e.layerId+"-"),t.addLayer(i)}setVisible(t,e,r){if(super.setVisible(t,e,r),r)for(let i of this.layers)t.hide(i.id);else for(let i of this.layers)t.show(i.id)}removeLayer(t,e){for(let r of this.layers)t.removeLayerEx(r.id);super.removeLayer(t,e)}}class hr extends k{constructor(){super();L(this,"overlay")}createDivOverlay(t,e,r){let i=this.evalValue(e,t,r);if(!!i.bounds&&!!i.width&&!!i.height){if(Array.isArray(i.bounds)&&i.bounds.length==2&&(i.bounds=new u.default.GeoBounds(u.default.geoPoint(i.bounds[0]),u.default.geoPoint(i.bounds[1]))),i.customHtml){let a=this.evalValue(e.customHtml,t,r);i.element=a}else if(i.customImage){i.customImage.toLowerCase().indexOf("<svg")==0&&(i.customImage="data:image/svg+xml;base64,"+window.btoa(unescape(encodeURIComponent(e.customImage))));const a=document.createElement("img");a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.width=i.width+"px",a.style.height=i.height+"px",a.src=i.customImage,a.style.pointerEvents="none",i.element=a}!i.element||(this.overlay=new u.default.DivOverlay(i),this.overlay.addTo(r))}}async addLayer(t,e){super.addLayer(t,e),this.createDivOverlay({},e,t)}setVisible(t,e,r){super.setVisible(t,e,r),this.overlay&&this.overlay.setVisible(!r)}removeLayer(t,e){this.overlay&&this.overlay.remove(),super.removeLayer(t,e)}}class gr extends k{constructor(){super();L(this,"overlay")}async addLayer(t,e){super.addLayer(t,e),this.overlay=new u.default.SvgOverlay(e),this.overlay.addTo(t)}setVisible(t,e,r){super.setVisible(t,e,r),this.overlay&&this.overlay.divOverlay&&this.overlay.divOverlay.setVisible(!r)}removeLayer(t,e){this.overlay&&this.overlay.remove(),super.removeLayer(t,e)}}class yr extends k{constructor(){super();L(this,"background")}async addLayer(t,e){super.addLayer(t,e),this.background=new u.default.BackgroundLayer(e),this.background.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.background.hide():this.background.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}}class mr extends k{constructor(){super();L(this,"sky")}async addLayer(t,e){super.addLayer(t,e),this.sky=new u.default.SkyLayer(e),this.sky.addTo(t,e.before)}setVisible(t,e,r){super.setVisible(t,e,r),r?this.sky.hide():this.sky.show()}removeLayer(t,e){t.removeLayerEx(e),super.removeLayer(t,e)}}const Se={line:Vt,fill:jt,symbol:Nt,marker:zt,popup:Ut,circle:Ht,fillExtrusion:Gt,heatmap:Wt,animateLine:_t,animateSymbol:Zt,animateFill:Jt,symbolCluster:Yt,markerCluster:Kt,text:Qt,breathingMarker:qt,rotatingMarker:Xt,haloRingMarker:$t,diffusedMarker:er,textBorderMarker:tr,fluorescenceMarker:rr,curve:sr,lineExtrusions:ir,arrowLine:or,pathAnimate:ar,symbolPathAnimate:nr,fillExtrusionsAnimate:lr,geojson:ur,draw:cr,raster:dr,vector:fr,divOverlay:hr,svgOverlay:gr,background:yr,sky:mr},B=class{constructor({dbName:s,version:t,tables:e}){L(this,"dbName","");L(this,"version",1);L(this,"tableList",[]);L(this,"db",null);L(this,"queue",[]);this.dbName=s,this.version=t,this.tableList=e}static getInstance(s){var e,r;B._instance=(e=B._instance)!=null?e:{};const t=(r=s==null?void 0:s.dbName)!=null?r:"";return B._instance[t]||(B._instance[t]=new B(s)),B._instance[t]}queryAll({tableName:s}){const t=[];return this.commitDb(s,e=>e.openCursor(),"readonly",(e,r)=>{this.cursor_success(e,{condition:()=>!0,handler:({currentValue:i})=>t.push(i),success:()=>r(t)})})}query({tableName:s,condition:t}){const e=[];return this.commitDb(s,r=>r.openCursor(),"readonly",(r,i)=>{this.cursor_success(r,{condition:t,handler:({currentValue:a})=>e.push(a),success:()=>i(e)})})}query_by_keyValue({tableName:s,key:t,value:e}){return this.commitDb(s,r=>r.index(t).get(e),"readonly",(r,i)=>{i(r.target.result||null)})}query_by_primaryKey({tableName:s,value:t}){return this.commitDb(s,e=>e.get(t),"readonly",(e,r)=>{r(e.target.result||null)})}update({tableName:s,condition:t,handle:e}){const r=[];return this.commitDb(s,i=>i.openCursor(),"readwrite",(i,a)=>{this.cursor_success(i,{condition:t,handler:({currentValue:n,cursor:l})=>{const c=e(n);r.push(c),l.update(c)},success:()=>{a(r)}})})}update_by_primaryKey({tableName:s,value:t,handle:e}){return this.commitDb(s,r=>r.get(t),"readwrite",(r,i,a)=>{const n=r.target.result;if(!n){i(null);return}const l=e(n);a.put(l),i(l)})}insert({tableName:s,data:t}){return this.commitDb(s,void 0,"readwrite",(e,r,i)=>{t instanceof Array?t.forEach(a=>i.put(a)):i.put(t),r()})}delete({tableName:s,condition:t}){const e=[];return this.commitDb(s,r=>r.openCursor(),"readwrite",(r,i)=>{this.cursor_success(r,{condition:t,handler:({currentValue:a,cursor:n})=>{e.push(a),n.delete()},success:()=>{i(e)}})})}delete_by_primaryKey({tableName:s,value:t}){return this.commitDb(s,e=>e.delete(t),"readwrite",(e,r)=>{r()})}open_db(){return new Promise((s,t)=>{const e=window.indexedDB.open(this.dbName,this.version);e.onerror=r=>{t(r)},e.onsuccess=r=>{this.db=r.target.result;let i;for(;i=this.queue.pop();)i();s(this)},e.onupgradeneeded=r=>{this.tableList.forEach(i=>{this.create_table(r.target.result,i)})}})}close_db(){return new Promise((s,t)=>{try{if(!this.db){s("\u8BF7\u5F00\u542F\u6570\u636E\u5E93");return}this.db.close(),this.db=null,B._instance&&delete B._instance[this.dbName],s(!0)}catch(e){t(e)}})}delete_db(s){return new Promise((t,e)=>{const r=indexedDB.deleteDatabase(s);r.onerror=i=>{e(i)},r.onsuccess=i=>{t(i)}})}delete_table(s){return this.commitDb(s,t=>t.clear(),"readwrite",(t,e)=>{e()})}create_table(s,{tableName:t,option:e,indexs:r=[]}){if(!s.objectStoreNames.contains(t)){const i=s.createObjectStore(t,e);for(const{key:a,option:n}of r)i.createIndex(a,a,n)}}commitDb(s,t,e="readwrite",r){return new Promise((i,a)=>{const n=()=>{try{if(this.db){const l=this.db.transaction(s,e).objectStore(s);if(!t){r(null,i,l);return}const c=t(l);c.onsuccess=h=>{r?r(h,i,l):i(h)},c.onerror=h=>{a(h)}}else a(new Error("\u8BF7\u5F00\u542F\u6570\u636E\u5E93"))}catch(l){a(l)}};this.db?n():this.queue.push(n)})}cursor_success(s,{condition:t,handler:e,success:r}){const i=s.target.result;if(i){const a=i.value;t(a)&&e({cursor:i,currentValue:a}),i.continue()}else r()}};let G=B;L(G,"_instance",null);const ke=({dbName:o,version:s=1,tables:t=[]})=>G.getInstance({dbName:o,version:s,tables:t}).open_db(),xe=o=>G.getInstance({dbName:o,version:1,tables:[]});class Ie{constructor(){L(this,"dbName");L(this,"tableName");L(this,"isInitDb");this.dbName="vjmapCache",this.tableName="cache",this.isInitDb=!1}async init(){this.isInitDb||(await ke({dbName:this.dbName,version:1,tables:[{tableName:this.tableName,option:{keyPath:"id",autoIncrement:!0},indexs:[{key:"id",option:{unique:!0}},{key:"key"},{key:"value"}]}]}),this.isInitDb=!0)}getInst(){return xe(this.dbName)}async getAll(){return await this.init(),await this.getInst().queryAll({tableName:this.tableName})}async getRecordByKey(s){return await this.init(),await this.getInst().query({tableName:this.tableName,condition:t=>t.key===s})}async getValueByKey(s,t){const e=await this.getRecordByKey(s);if(e.length!=0)return t===!0?JSON.parse(e[0].value):e[0].value}async setValueByKey(s,t,e){return await this.upsert({key:s,value:e===!0?JSON.stringify(t,null,0):t})}async upsert(s){return await this.init(),(await this.getRecordByKey(s.key)).length==0?await this.getInst().insert({tableName:this.tableName,data:s}):await this.getInst().update({tableName:this.tableName,condition:e=>e.key===s.key,handle:e=>(e.value=s.value,e)})}async deleteRecord(s){return await this.init(),await this.getInst().delete({tableName:this.tableName,condition:t=>t.key===s})}async deleteTable(){return await this.init(),await this.getInst().delete_table(this.tableName)}async deleteDb(){return await this.init(),await this.getInst().delete_db(this.dbName)}toStringKey(s,t){return t=t!=null?t:"",t+JSON.stringify(s,null,0)}}const Q=new Ie;async function q(o,s,t){var g,f;let e=o.getService();const r={...s,...t,mapId:(g=e.currentMapParam())==null?void 0:g.mapid,version:(f=e.currentMapParam())==null?void 0:f.version,workspace:e.getCurWorkspaceName()};let i=await Q.getValueByKey(Q.toStringKey(r,"query_"),!0);if(i)return i;let a;const n=[];let l=0;const c=5e4;let h;for(s.bounds&&(h=u.default.GeoBounds.fromString(s.bounds).toArray());;){const y=await e.conditionQueryFeature({condition:s.condition,bounds:h,fields:"",includegeom:!0,realgeom:!0,isContains:s.isContains,beginpos:l,limit:c,...t});if(!y.result||(l+=c,n.push(...y.result||[]),n.length>=y.recordCount))break}a={result:n,recordCount:n.length};let d=ue(o,a,s.coordType==1);return await Q.setValueByKey(Q.toStringKey(r,"query_"),d,!0),d}const V=o=>{const s=new Set(["id","isEnvelop","envelop","geojson","geom","isPoint","isline","points"]),t={};for(const e in o)s.has(e)||(t[e]=o[e]);return t};function ue(o,s,t){const e={features:[],type:"FeatureCollection"};if(s&&s.result&&s.result.length>0)for(const i of s.result)if(t){if(i.geom&&i.geom.geometries){let a={id:i.id,type:"Feature",properties:V(i)};i.geom.geometries.length==1?a={...a,geometry:i.geom.geometries[0]}:a={...a,geometry:{geometries:i.geom.geometries,type:"GeometryCollection"}},e.features.push(a)}}else{const a=i.points||i.positon||i.location||i.origin||i.center;if(a){const l=a.split(";").map(c=>o.toLngLat(u.default.GeoPoint.fromString(c)));if(l.length==1){const c={type:"Feature",id:i.id,properties:V(i),geometry:{type:"Point",coordinates:l[0]}};e.features.push(c)}else if(l.length>1){const c={type:"Feature",id:i.id,properties:V(i),geometry:{type:"LineString",coordinates:l}};e.features.push(c)}}}return o.fromLngLat(e)}async function W(o,s,t){let e;if(s.reqType=="SOURCE")s.fromSourceId&&(e=await t.getSourceData(s.fromSourceId));else{s.data&&typeof s.data=="string"&&(s.data=JSON.parse(s.data)),s.header&&typeof s.header=="string"&&(s.header=JSON.parse(s.header));let r={headers:{Accept:"application/json","Content-Type":"application/json",...s.header}};s.url&&(s.reqType=="POST"?e=await u.default.httpHelper.post(s.url,s.data,r):e=await u.default.httpHelper.get(s.url,s.data,r))}return s.processJS&&(e=await Te(e,s.processJS,o,t)),e}const ce=o=>{let s={type:"FeatureCollection",features:[]};for(let t=0;t<o.length;t++){let e=o[t];Array.isArray(e)&&e.length==2&&typeof e[0]=="number"?s.features.push({type:"Feature",id:t+1,properties:{index:t+1},geometry:{type:"Point",coordinates:e}}):Array.isArray(e)&&Array.isArray(e[0])&&typeof e[0][0]=="number"?s.features.push({type:"Feature",id:t+1,properties:{index:t+1},geometry:{type:"LineString",coordinates:o[t]}}):Array.isArray(e)&&Array.isArray(e[0])&&Array.isArray(e[0][0])&&typeof e[0][0][0]=="number"&&s.features.push({type:"Feature",id:t+1,properties:{index:t+1},geometry:{type:"Polygon",coordinates:o[t]}})}return s};async function Te(o,s,t,e){Array.isArray(o)&&(o=ce(o));const r=Object.getPrototypeOf(async function(){}).constructor,i=new r("data","vjmap","map","mapApp","utils",s),a={ProcessDataToFeatureCollection:ue,convertArrayToGeoJson:ce};return await i(o,u.default,t,e,a)}const $e={scatterDot:(o,s={})=>{var r;const t=(r=s.size)!=null?r:100;return{width:t,height:t,data:new Uint8Array(t*t*4),onAdd:function(){let i=document.createElement("canvas");i.width=this.width,i.height=this.height,this.context=i.getContext("2d")},render:function(){var d,g;const i=(d=s.duration)!=null?d:1500,a=(g=s.rgb)!=null?g:[0,150,0];let n=performance.now()%i/i,l=t/2*.3,c=t/2*.7*n+l,h=this.context;return h.clearRect(0,0,this.width,this.height),h.beginPath(),h.arc(this.width/2,this.height/2,c,0,Math.PI*2),h.fillStyle="rgba("+a[0]+","+a[1]+","+a[2]+","+(1-n)+" )",h.fill(),h.beginPath(),h.arc(this.width/2,this.height/2,l,0,Math.PI*2),this.data=h.getImageData(0,0,this.width,this.height).data,o.triggerRepaint(),!0}}},pulsingDot:(o,s={})=>{var r;const t=(r=s.size)!=null?r:100;return{width:t,height:t,data:new Uint8Array(t*t*4),onAdd:function(){const i=document.createElement("canvas");i.width=this.width,i.height=this.height,this.context=i.getContext("2d")},render:function(){var g,f,y,m,w,p,b;const i=(g=s.duration)!=null?g:1e3,a=performance.now()%i/i,n=(f=s.outFillRgb)!=null?f:[255,200,200],l=(y=s.innerFillRgb)!=null?y:[255,100,100],c=t/2*((m=s.innerRadiusRatio)!=null?m:.3),h=t/2*((w=s.outerRadiusRatio)!=null?w:.7)*a+c,d=this.context;return d.clearRect(0,0,this.width,this.height),d.beginPath(),d.arc(this.width/2,this.height/2,h,0,Math.PI*2),d.fillStyle="rgba("+n[0]+","+n[1]+","+n[2]+","+(1-a)+" )",d.fill(),d.beginPath(),d.arc(this.width/2,this.height/2,c,0,Math.PI*2),d.fillStyle="rgba("+l[0]+","+l[1]+","+l[2]+",1)",d.strokeStyle=(p=s.innerStrokeStyle)!=null?p:"white",d.lineWidth=2+((b=s.innerLineWidth)!=null?b:4)*(1-a),d.fill(),d.stroke(),this.data=d.getImageData(0,0,this.width,this.height).data,o.triggerRepaint(),!0}}}},et=()=>["https://c.tile.openstreetmap.org/{z}/{x}/{y}.png"],Fe=o=>{const s=["85c9d12d5d691d168ba5cb6ecaa749eb","583e63953a6ed6bf304e68120db4c512","93d1fdef41f93d2211deed6d22780c48","7e2ced6843b376a14f69a9f5885d3d2d","44964a97c8c44e4d04efdf3cba594467","57f1b8146ef867f14189f3f4bb1adc1c"],t=s[u.default.randInt(0,s.length-1)];return[o?"https://t{0-7}.tianditu.gov.cn/DataServer?T=img_w&X={x}&Y={y}&L={z}&tk="+t:"https://t{0-7}.tianditu.gov.cn/DataServer?T=vec_w&X={x}&Y={y}&L={z}&tk="+t,"https://t{0-7}.tianditu.gov.cn/DataServer?T=cva_w&X={x}&Y={y}&L={z}&tk="+t]},Pe=o=>o?["https://webst0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=6&x={x}&y={y}&z={z}","https://webst0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"]:["https://webrd0{1-4}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}"],Ee=(o,s)=>{let t=s.webMapTiles;if(t||(s.baseMapType=="WGS84"?t=Fe():s.baseMapType=="GCJ02"&&(t=Pe())),!!t)for(let e=0;e<t.length;e++){const r=`${s.baseMapType}_base_webmap_source_${e}`;o.addRasterSource(r,{type:"raster",tiles:ae(t[e],o)});const i=`${s.baseMapType}_base_webmap_layer_${e}`;o.addRasterLayer(i,r,{})}},pr={"FullscreenControl.Enter":"\u8FDB\u5165\u5168\u5C4F","FullscreenControl.Exit":"\u9000\u51FA\u5168\u5C4F","NavigationControl.ZoomIn":"\u653E\u5927","NavigationControl.ZoomOut":"\u7F29\u5C0F","NavigationControl.ResetBearing":"\u65B9\u4F4D\u89D2\u590D\u4F4D","ScaleControl.Meters":"","ScaleControl.Kilometers":"K"};var Me=(o=>(o.None="none",o.Direct="direct",o.Auto="auto",o.Param="param",o))(Me||{});const X=async(o,s,t,e)=>{if(Array.isArray(t)){for await(let r of t)if(!r.layer){r.style||(r.style={backcolor:e!=null?e:0});let i=await o.createStyle(r.style,r.mapid,r.version);r.layer=i.stylename}}else if(!t.layer){t.style||(t.style={backcolor:e!=null?e:0});let r=await o.createStyle(t.style,t.mapid,t.version);t.layer=r.stylename}return t},Be=async(o,s,t,e)=>{let r;const i=async a=>{var c,h,d,g,f;if(!a.mapid)return;let n=await o.metadata(a.mapid,a.version),l=u.default.GeoBounds.fromString(n.bounds);if(s=="auto")if(O(t)){let y=a.fourParameterX!==void 0?[(c=a.fourParameterX)!=null?c:0,(h=a.fourParameterY)!=null?h:0,(d=a.fourParameterScale)!=null?d:1,(g=a.fourParameterRotate)!=null?g:0].join(","):void 0,m=l.toPointArray(),w=new u.default.GeoBounds;for await(let p of m){let b=await Ge(o,u.default.geoPoint(p),(f=a.crs)!=null?f:"",y,t=="WGS84");w.update([u.default.geoPoint(b)])}return w}else return;else if(s=="param"){if(O(a.baseMapType))return;let y=l.toPointArray(),m;for(let w of y)if(a.coordinates){let p=We(u.default.geoPoint(w),a.coordinates,a.isSetRotateZero,O(t));m||(m=new u.default.GeoBounds),m.update([u.default.geoPoint(p)])}return m}return l};if(Array.isArray(e))for await(let a of e){let n=await i(a);if(!n)return;r||(r=new u.default.GeoBounds),r.updateByBounds(n)}else{let a=await i(e);if(!a)return;r||(r=new u.default.GeoBounds),r.updateByBounds(a)}return r},Oe=(o,s,t)=>{const e=r=>{var i,a,n,l,c,h;if(o=="param"){if(!r.coordinates||r.coordinates.length<=1)return;if(O(s.baseMapType)){let d=r.coordinates.map(y=>u.default.geoPoint(u.default.Projection.lngLat2Mercator([y.x1,y.y1]))),g=r.coordinates.map(y=>u.default.geoPoint([y.x2,y.y2])),f=u.default.coordTransfromGetFourParamter(d,g,(i=r.isSetRotateZero)!=null?i:!1,!0);return[f.dx,f.dy,f.scale,f.rotate]}else{let d=r.coordinates.map(y=>u.default.geoPoint([y.x1,y.y1])),g=r.coordinates.map(y=>u.default.geoPoint([y.x2,y.y2])),f=u.default.coordTransfromGetFourParamter(d,g,(a=r.isSetRotateZero)!=null?a:!1,!0);return[f.dx,f.dy,f.scale,f.rotate]}}else return r.fourParameterX!==void 0?[(n=r.fourParameterX)!=null?n:0,(l=r.fourParameterY)!=null?l:0,(c=r.fourParameterScale)!=null?c:1,(h=r.fourParameterRotate)!=null?h:0]:void 0};if(Array.isArray(t)){if(t.length==1)return{mapid:t[0].mapid,version:t[0].version,layers:t[0].layer,crs:t[0].crs,fourParameter:e(t[0])};{let r=[],i=[],a=[],n=[],l=[];for(let c=0;c<t.length;c++)r.push(t[c].mapid),i.push(t[c].version),a.push(t[c].layer),n.push(t[c].crs),l.push(e(t[c]));return{mapid:r,version:i,layers:a,crs:n,fourParameter:l}}}else return{mapid:t.mapid,version:t.version,layers:t.layer,crs:t.crs,fourParameter:e(t)}},Re=async(o,s,t,e,r)=>(await X(o,s,e),o.wmsTileUrl({...Oe(s,t,e),mapbounds:t.mapbounds,...r})),Ve=async(o,s,t,e,r)=>{await X(o,s,e);const i=u.default.cloneDeep(Oe(s,t,e));if(i.fourParameter)if(Array.isArray(i.mapid))for(let a=0;a<i.fourParameter.length;a++)typeof i.fourParameter[a][0]=="number"&&(i.fourParameter[a][0]=-i.fourParameter[a][0]),typeof i.fourParameter[a][1]=="number"&&(i.fourParameter[a][1]=-i.fourParameter[a][1]),i.fourParameter[a][0]=i.fourParameter[a][0]||0,i.fourParameter[a][1]=i.fourParameter[a][1]||0,i.fourParameter[a][2]=i.fourParameter[a][2]||1,i.fourParameter[a][3]=i.fourParameter[a][3]||0;else typeof i.fourParameter[0]=="number"&&(i.fourParameter[0]=-i.fourParameter[0]),typeof i.fourParameter[1]=="number"&&(i.fourParameter[1]=-i.fourParameter[1]),i.fourParameter[0]=i.fourParameter[0]||0,i.fourParameter[1]=i.fourParameter[1]||0,i.fourParameter[2]=i.fourParameter[2]||1,i.fourParameter[3]=i.fourParameter[3]||0;return o.wmsTileUrl({...i,srs:"EPSG:3857",webMapType:t.baseMapType,...r})},je=async(o,s,t,e)=>{var a,n,l,c,h,d;let r;if(Array.isArray(t)?r=t.find(g=>O(g.baseMapType)):r=t,!r)return;const i=((a=r.webMapTiles)==null?void 0:a.map(g=>Ce(g)))||[];return o.webMapUrl({tileCrs:r.baseMapType=="GCJ02"?"gcj02":"wgs84",tileUrl:(n=i==null?void 0:i.map(g=>g.tileUrl))!=null?n:"",tileSize:256,tileRetina:1,tileMaxZoom:18,tileShards:i.length>=0?i[0].tileShards:"",tileToken:"",tileFlipY:!1,mapbounds:s.mapbounds,srs:r.crs,fourParameterBefore:r.fourParameterX!==void 0?[(l=r.fourParameterX)!=null?l:0,(c=r.fourParameterY)!=null?c:0,(h=r.fourParameterScale)!=null?h:1,(d=r.fourParameterRotate)!=null?d:0].join(","):void 0})},Ne=async(o,s,t,e,r)=>{await X(o,s,e);let i;return O(t.baseMapType)||(i=t.mapbounds,i&&(i=i.replace("[",""),i=i.replace("]",""))),o.wmsTileUrl({...Oe(s,t,e),mapbounds:i,...r})},He=async(o,s,t,e)=>{let r;if(t=="direct"?r=await Re(o,t,s,e.maps,e.layerProps):t=="auto"?O(s.baseMapType)?r=await Ve(o,t,s,e.maps,e.layerProps):r=await je(o,s,e.maps,e.layerProps):t=="param"&&(r=await Ne(o,t,s,e.maps,e.layerProps)),!!r)return[r]},Ge=async(o,s,t,e,r)=>{if(e){let n=e.split(",");s=u.default.coordTransfromByFourParamter(s,{dx:+n[0],dy:+n[1],scale:+n[2],rotate:+n[3]})}let a=(await o.cmdTransform(t,"EPSG:4326",s))[0];return r===!1&&(a=u.default.transform.convert(a,u.default.transform.CRSTypes.EPSG4326,u.default.transform.CRSTypes.AMap)),a},tt=async(o,s,t,e,r)=>{r===!1&&(s=u.default.transform.convert(s,u.default.transform.CRSTypes.AMap,u.default.transform.CRSTypes.EPSG4326));let a=(await o.cmdTransform("EPSG:4326",t,u.default.geoPoint(s)))[0];if(e){let n=e.split(",");a=u.default.coordTransfromByFourParamter(u.default.geoPoint(a),{dx:+n[0],dy:+n[1],scale:+n[2],rotate:+n[3]})}return u.default.geoPoint(a).toArray()},We=(o,s,t,e)=>{let r;e?r=s.map(l=>u.default.geoPoint(u.default.Projection.lngLat2Mercator([l.x1,l.y1]))):r=s.map(l=>u.default.geoPoint([l.x1,l.y1]));let i=s.map(l=>u.default.geoPoint([l.x2,l.y2]));if(r.length==0||i.length==0)return u.default.geoPoint(o);let a=u.default.coordTransfromGetFourParamter(i,r,t!=null?t:!1,!0),n=u.default.coordTransfromByFourParamter(o,a);return e&&(n=u.default.geoPoint(u.default.Projection.mercator2LngLat(n))),n},rt=(o,s,t,e)=>{let r;e?r=s.map(n=>u.default.geoPoint(u.default.Projection.lngLat2Mercator([n.x1,n.y1]))):r=s.map(n=>u.default.geoPoint([n.x1,n.y1]));let i=s.map(n=>u.default.geoPoint([n.x2,n.y2]));if(r.length==0||i.length==0)return u.default.geoPoint(o);let a=u.default.coordTransfromGetFourParamter(r,i,t!=null?t:!1,!0);return e&&(o=u.default.geoPoint(u.default.Projection.lngLat2Mercator(o))),u.default.coordTransfromByFourParamter(o,a)};class st{constructor(s){L(this,"config");L(this,"svc");L(this,"map");L(this,"sources");L(this,"layers");L(this,"controls");L(this,"layersInst");L(this,"projectKey");L(this,"containerId");L(this,"timeMgr");L(this,"isEditorMode");L(this,"isDisableRunProgram");L(this,"context");L(this,"programCleaner");L(this,"oldCacheImages");this.config=s||{},this.sources=[],this.layers=[],this.layersInst={},this.timeMgr={},this.config.mapSources=[],this.config.mapLayers=[]}mount(s,t){var a,n,l,c,h,d,g;if(this.svc)return;if(this.containerId=s,(a=this.config)!=null&&a.backgroundColor){const f=document.getElementById(s);f&&(f.style.backgroundColor=(n=this.config)==null?void 0:n.backgroundColor)}this.svc=new u.default.Service((c=(l=this.config.serviceUrl)!=null?l:t==null?void 0:t.serviceUrl)!=null?c:"",(d=(h=this.config.serviceToken)!=null?h:t==null?void 0:t.serviceToken)!=null?d:""),this.config.workspace&&this.svc.switchWorkspace(this.config.workspace),this.config.accessKey&&this.config.accessKey.split(";").map(f=>this.svc.addAccessKey(f));const e=(g=this.config.mapInitBounds)!=null?g:"[-10000,-10000,10000,10000]",r=u.default.GeoBounds.fromString(e),i=new u.default.GeoProjection(r);this.map=new u.default.Map({container:s,style:{version:this.svc.styleVersion(),glyphs:this.svc.glyphsUrl(),sources:{},layers:[]},center:i.toLngLat(r.center()),zoom:2,renderWorldCopies:!1,preserveDrawingBuffer:this.isEditorMode?!0:void 0,doubleClickZoom:!1,locale:pr,...this.config.mapOptions}),this.map.attach(this.svc,i)}attachMap(s){this.map=s,this.svc=this.map.getService()}isWebBaseMap(s){var e;let t=(e=s!=null?s:this.config)!=null?e:{};return!(t.baseMapType==""||t.baseMapType=="CAD"||t.baseMapType===void 0)}async setConfig(s,t){var n,l,c,h,d,g,f,y,m,w,p,b,D,C;if(s||(s=u.default.cloneDeep(this.config)),!this.map)return;if(await this.map.onLoad(),this.clearData(),s&&(this.config=s),(n=this.config)!=null&&n.backgroundColor){const v=this.map.getContainer();v&&(v.style.backgroundColor=(l=this.config)==null?void 0:l.backgroundColor)}const e=[...(c=s==null?void 0:s.mapSources)!=null?c:[]],r=[...(h=s==null?void 0:s.mapLayers)!=null?h:[]];if(this.svc=new u.default.Service((f=(g=this.config.serviceUrl)!=null?g:(d=this.svc)==null?void 0:d.serverUrl)!=null?f:"",(w=(m=this.config.serviceToken)!=null?m:(y=this.svc)==null?void 0:y.accessToken)!=null?w:""),this.isWebBaseMap()){let v=new u.default.LnglatProjection;this.map.attach(this.svc,v),Ee(this.map,this.config)}else{if(!((p=this.config.mapOpenOptions)!=null&&p.mapid)&&this.config.mapInitBounds){const v=this.config.mapInitBounds,S=u.default.GeoBounds.fromString(v),x=new u.default.GeoProjection(S);this.map.setMapProjection(x)}this.map.attach(this.svc,this.map.getMapProjection())}if(this.config.workspace&&this.svc.switchWorkspace(this.config.workspace),this.config.accessKey&&this.config.accessKey.split(";").map(v=>this.svc.addAccessKey(v)),!this.isWebBaseMap()&&(this.config.mapOpenOptions=this.config.mapOpenOptions||{},(b=this.config.mapOpenOptions)!=null&&b.style||(this.config.mapOpenOptions.style=u.default.openMapDarkStyle()),(D=this.config.mapOpenOptions)!=null&&D.mapid)){const v=await this.switchMap(this.config.mapOpenOptions);if(v!=null&&v.error)return{error:v.error}}t||this.setMapOptions((C=this.config.mapOptions)!=null?C:{}),await this.map.onLoad(!0),await this.addMapImages();let i=[],a=[];e.filter(v=>!(v.tag=="change"&&v.change&&v.change.reqType=="SOURCE")).forEach(v=>i.push(this.addSource(v,!0))),await Promise.all(i),e.filter(v=>v.tag=="change"&&v.change&&v.change.reqType=="SOURCE").forEach(v=>a.push(this.addSource(v,!0))),await Promise.all(a);for(let v of r)await this.addLayer(v,!0);this.addControls(),await this.execProgram()}async setMapOpenOptions(s){this.config.mapOpenOptions={...this.config.mapOpenOptions,...s},await this.setConfig()}setMapOptions(s){this.config.mapOptions={...this.config.mapOptions,...s},this.map&&(s.center?this.map.setCenter(s.center):this.isWebBaseMap()&&this.map.setCenter([116.3912,39.9073]),s.zoom!==void 0?this.map.setZoom(s.zoom):this.isWebBaseMap()&&this.map.setZoom(8),s.bearing!==void 0&&this.map.setBearing(s.bearing),s.pitch!==void 0&&this.map.setPitch(s.pitch),s.dragRotate===!1&&this.map.dragRotate.isEnabled()?(this.map.dragRotate.disable(),this.map.touchZoomRotate.disableRotation(),this.map.getCanvasContainer().oncontextmenu=t=>{t.preventDefault()}):s.dragRotate&&!this.map.dragRotate.isEnabled()&&(this.map.dragRotate.enable(),this.map.touchZoomRotate.enableRotation(),this.map.getCanvasContainer().oncontextmenu=()=>{}),s.pitchWithRotate===!1?this.map.setMaxPitch(0):this.map.setMaxPitch(85))}async addMapImages(){try{if(!this.config.mapImages)return;this.oldCacheImages=this.oldCacheImages||{};let s=[...this.config.mapImages];s=s.filter(e=>e.key&&e.value),s=s.filter(e=>{const r=e.value+"_"+e.options;return this.oldCacheImages[e.key]!=r});for(let e of s)this.map.hasImage(e.key)&&this.map.removeImage(e.key);let t=[];for(let e of s){let r;if(this.oldCacheImages[e.key]=e.value+"_"+e.options,typeof e.options=="string")try{r=JSON.parse(e.options)}catch(a){console.error(a)}let i=$e[e.value];i?t.push(this.map.addImage(e.key,i(this.map,r),r)):t.push(this.map.loadImageEx(e.key,e.value,r))}await Promise.all(t)}catch(s){console.error(s)}}async clearData(){if(!this.map)return;const{sources:s}=this.map.getStyle();this.removePrograms();for(const t in this.layersInst){const e=this.layersInst[t];e&&e.removeLayer(this.map,t)}for(const t in s)this.map.removeSourceEx(t);this.map.removeMarkers(),this.map.removePopups(),this.removeControls(),this.sources=[],this.layers=[],this.layersInst=[],this.config.mapSources=[],this.config.mapLayers=[],this.oldCacheImages={};for(let t in this.timeMgr)clearInterval(this.timeMgr[t]);this.timeMgr={}}removePrograms(){if(this.programCleaner){for(let s of this.programCleaner)s&&s();this.programCleaner=[]}}async execProgram(){if(!this.isDisableRunProgram&&(this.removePrograms(),this.config.program&&this.config.program.onMapLoaded)){let s=await De(this.config.program.onMapLoaded,this.map,this,this.context);typeof s=="function"&&(this.programCleaner=this.programCleaner||[],this.programCleaner.push(s))}}async destory(){this.clearData(),this.map&&(this.map.remove(),this.map=null)}async switchMap(s){this.config.mapOpenOptions=s;const t=await this.map.switchMap(s,s.isKeepOldLayers,s.isVectorStyle,s.isSetCenter,s.isFitBounds);return t!=null&&t.error?{error:t.error}:t}async addSource(s,t){var i,a;const e=u.default.cloneDeep(s);if(this.sources.findIndex(n=>n.id===e.id)>=0)return!1;if(this.sources.push(u.default.cloneDeep(e)),t&&((i=this.config.mapSources)==null?void 0:i.findIndex(l=>l.id===e.id))==-1&&((a=this.config.mapSources)==null||a.push(u.default.cloneDeep(e))),e.tag==="query"){let n=await q(this.map,e.query);e.source.data=n}else if(e.tag==="change"){let n=await W(this.map,e.change,this);e.source.data=n,this.addTimer(e)}if(e.source.type==="geojson"){const n=u.default.cloneDeep(e.source);n.data=this.map.toLngLat(n.data);for(let l in e.props)n[l]=e.props[l];this.map.addSourceEx(e.id,n)}else await this.updateSource(e);return!0}async getSourceData(s){const t=this.sources.findIndex(r=>r.id===s);if(t<0)return;const e=this.sources[t];if(e.tag==="query")return await q(this.map,e.query);if(e.tag==="change")return await W(this.map,e.change,this);if(e.source.type==="geojson")return u.default.cloneDeep(e.source).data}async setSourceData(s,t,e){var n,l;const r=this.sources.findIndex(c=>c.id===s);if(r<0)return;let i=-1;e&&(i=(l=(n=this.config.mapSources)==null?void 0:n.findIndex(c=>c.id===s))!=null?l:-1);let a=!0;if(this.sources[r].tag==="query")this.sources[r].query=t,i>=0&&this.config.mapSources&&(this.config.mapSources[i].query=u.default.cloneDeep(t)),t=await q(this.map,this.sources[r].query);else if(this.sources[r].tag==="change")this.sources[r].change=t,i>=0&&this.config.mapSources&&(this.config.mapSources[i].change=u.default.cloneDeep(t)),t=await W(this.map,this.sources[r].change,this),this.addTimer(this.sources[r]);else if(this.sources[r].source.type==="geojson")this.sources[r].source.data=t,i>=0&&this.config.mapSources&&(this.config.mapSources[i].source.data=u.default.cloneDeep(t));else{if(this.sources[r].tag==="wms"){const c=this.sources[r].source.type;this.sources[r].wms=t.wms,this.sources[r].source={...t.source},c&&(this.sources[r].source.type=c),i>=0&&this.config.mapSources&&(this.config.mapSources[i].wms=u.default.cloneDeep(t.wms),this.config.mapSources[i].source={type:this.sources[i].source.type,...t.source},c&&(this.config.mapSources[i].source.type=c))}else{const c=this.sources[r].source.type;this.sources[r].source=u.default.cloneDeep(t),c&&(this.sources[r].source.type=c),i>=0&&this.config.mapSources&&(this.config.mapSources[i].source=u.default.cloneDeep(t),c&&(this.config.mapSources[i].source.type=c))}await this.updateSource(this.sources[r],!0),a=!1}a&&this.map.setData(s,this.map.toLngLat(t)),await this.notifySourceDataChange(s,!a)}async updateSource(s,t){var r,i,a,n,l,c,h,d;let e=u.default.cloneDeep(s);if(t&&this.map.removeSourceEx(e.id),e.source.type==="raster"||e.source.type==="vector"){if(e.source.bounds){const g=this.map.toLngLat([e.source.bounds[0],e.source.bounds[1]]),f=this.map.toLngLat([e.source.bounds[2],e.source.bounds[3]]);e.source.bounds=[g[0],g[1],f[0],f[1]]}if(e.tag=="wms"&&(e.source.tiles=await He(this.svc,{baseMapType:this.config.baseMapType,mapid:(r=this.config.mapOpenOptions)==null?void 0:r.mapid,version:(i=this.config.mapOpenOptions)==null?void 0:i.version,mapbounds:this.map.getGeoBounds(1).toString()},(a=e.wms)==null?void 0:a.overlayType,(n=e.wms)==null?void 0:n.param),!e.source.bounds)){let g=await Be(this.svc,(l=e.wms)==null?void 0:l.overlayType,(c=this.config.baseMapType)!=null?c:"",(d=(h=e.wms)==null?void 0:h.param)==null?void 0:d.maps);if(g){let f=this.map.toLngLat(g).toArray();e.source.bounds=[f[0][0],f[0][1],f[1][0],f[1][1]]}}e.source.tiles||(e.source.tiles=ae(e.source.tiles,this.map)),e.source.type==="raster"?this.map.addRasterSource(e.id,e.source):this.map.addVectorSource(e.id,e.source,{})}else e.source.type==="image"||e.source.type==="video"?(e.source.coordinates&&(e.source.coordinates=this.map.toLngLat(e.source.coordinates)),e.source.type==="image"?this.map.addImageSource(e.id,e.source):this.map.addVideoSource(e.id,e.source)):this.map.addSourceEx(e.id,e.source)}removeSource(s,t){var r,i;for(let a=this.layers.length-1;a>=0;a--)this.layers[a].sourceId==s&&this.removeLayer(this.layers[a].layerId,!0);this.map.removeSourceEx(s);const e=this.sources.findIndex(a=>a.id===s);if(e>=0&&this.sources.splice(e,1),t){const a=(r=this.config.mapSources)==null?void 0:r.findIndex(n=>n.id===s);a!==void 0&&a>=0&&((i=this.config.mapSources)==null||i.splice(a,1))}this.clearTimer(s)}async addLayer(s,t){var n,l,c;const e=u.default.cloneDeep(s);if(this.layers.findIndex(h=>h.layerId===e.layerId)<0&&this.layers.push(u.default.cloneDeep(e)),t&&((n=this.config.mapLayers)==null?void 0:n.findIndex(d=>d.layerId===e.layerId))==-1&&((l=this.config.mapLayers)==null||l.push(u.default.cloneDeep(e))),e.visibleOff||this.layersInst[e.layerId])return;let i=Se[e.type];i||console.error(`\u56FE\u5C42\u7C7B\u578B ${e.type} \u672A\u6CE8\u518C`);let a=new i;if(await a.addLayer(this.map,e),this.layersInst[e.layerId]=a,s.isLowest&&a.getLayerId()){let h=this.map.getStyle().layers,d=(c=a.getLayerId())!=null?c:[];Array.isArray(d)||(d=[d]);for(let g=0;g<h.length-1;g++)h.findIndex(f=>f.id==d[g])>=0&&this.map.moveLayer(d[g],h[0].id)}}async setLayerStyle(s,t,e){var i;const r=this.layers.findIndex(a=>a.layerId===s);if(!(r<0)&&(this.layersInst[s]?(this.layersInst[s].setLayerStyle(this.map,s,t,this.layers[r]),this.layers[r]=P(this.layers[r],t)):(this.layers[r]=P(this.layers[r],t),await this.addLayer(this.layers[r],e)),e)){const a=(i=this.config.mapLayers)==null?void 0:i.findIndex(n=>n.layerId===s);a!==void 0&&a>=0&&this.config.mapLayers&&(this.config.mapLayers[a]=u.default.cloneDeep(this.layers[r]))}}async setLayerVisible(s,t,e){var i;const r=this.layers.findIndex(a=>a.layerId===s);if(!(r<0)&&(this.layers[r].visibleOff=t,this.layersInst[s]||await this.addLayer(this.layers[r],e),this.layersInst[s].setVisible(this.map,s,t),e)){const a=(i=this.config.mapLayers)==null?void 0:i.findIndex(n=>n.layerId===s);a!==void 0&&a>=0&&this.config.mapLayers&&(this.config.mapLayers[a].visibleOff=t)}}async setSourceVisible(s,t,e){for(let r of this.layers)r.sourceId==s&&await this.setLayerVisible(r.layerId,t)}removeLayer(s,t){var r,i;if(!this.layersInst[s])return;this.layersInst[s].removeLayer(this.map,s),delete this.layersInst[s];const e=this.layers.findIndex(a=>a.layerId===s);if(e>=0&&this.layers.splice(e,1),t){const a=(r=this.config.mapLayers)==null?void 0:r.findIndex(n=>n.layerId===s);a!==void 0&&a>=0&&((i=this.config.mapLayers)==null||i.splice(a,1))}}addTimer(s){this.clearTimer(s.id),s.change.interval>0&&(this.timeMgr[s.id]=setInterval(async()=>{if(!this.map)return;let t=await W(this.map,s.change,this);this.map.getSource(s.id)!==void 0&&(this.map.setData(s.id,this.map.toLngLat(t)),await this.notifySourceDataChange(s.id,!1,!0))},s.change.interval*1e3))}clearTimer(s){this.timeMgr[s]&&(clearInterval(this.timeMgr[s]),delete this.timeMgr[s])}removeControls(){if(this.controls){for(let s of this.controls)s&&this.map.removeControl(s);this.controls=[]}}addControls(){if(this.removeControls(),!!this.config.controls){this.controls=this.controls||[];for(let s of this.config.controls){let t,e=s.name,r=s.options?JSON.parse(s.options):{};if(e=="DrawTool")t=new u.default.Draw.Tool(r);else{if(e=="Custom"){if(e=r.controlName,!e){console.warn("custom control options need include controlName field "),this.controls.push(null);continue}}else e=="MiniMapControl"&&(r.containerStyle||(r.containerStyle={background:this.config.backgroundColor,transform:"scale(0.6)",transformOrigin:`${s.position.indexOf("left")>=0?"0%":"100%"} ${s.position.indexOf("top")>=0?"0%":"100%"}`}));if(!e)continue;if(!u.default[e]){console.warn(`${e} is not vjmap class`),this.controls.push(null);continue}t=new u.default[e](r)}r!=null&&r.locale&&(this.map._locale={...this.map._locale,...r==null?void 0:r.locale}),this.map.addControl(t,s.position),this.controls.push(t)}}}getConfig(){return this.config}findDepsSourceId(s,t){var e;if(!!s){for(let r=0;r<this.sources.length;r++)if(this.sources[r].tag==="change"&&((e=this.sources[r].change)==null?void 0:e.fromSourceId)==s){let i=this.sources[r].id;i&&!t.has(i)&&(t.add(i),this.findDepsSourceId(i,t))}}}async notifySourceDataChange(s,t,e){var i,a;if(!s)return;let r=new Set;r.add(s),this.findDepsSourceId(s,r);for(let n of r){const l=this.sources.findIndex(c=>c.id===n);if(l>=0&&this.sources[l].tag==="change"&&((i=this.sources[l].change)==null?void 0:i.fromSourceId)){const c=await W(this.map,this.sources[l].change,this);this.map.setData(n,this.map.toLngLat(c))}}for(let n in this.layersInst)for(let l of r)(a=this.layersInst[n])==null||a.onSourceDataChange(this.map,l,t,e)}getSysImages(){return Object.keys($e)}static guid(s=8){return"x".repeat(s).replace(/[xy]/g,t=>{const e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)})}}const de=(o,s,t,e,r)=>{var a;if(s.symbol&&s.text&&r)return Ar(o,s,r);const i=new u.default.DbLine({color:s.color?parseInt(s.color.substring(1),16):0,start:o,end:o,alpha:((a=s.opacity)!=null?a:1)*255});return z(i),[i]},fe=(o,s,t)=>{const e=[0,5,9,13,15,18,20,25,30,35,40,50,53,60,70,80,90,100,106,120,140,158,200,211];let r=s.line_width?s.line_width*10:void 0;if(r){for(let n=1;n<e.length;n++)if(r<e[n]){r=e[n-1];break}}let i=t?s.line_opacity:s.opacity;if(s.center&&s.pointInCircle)return wr(o,s,r,i);const a=new u.default.Db2dPolyline({color:s.color?parseInt(s.color.substring(1),16):0,points:o,lineWidth:r,alpha:(i!=null?i:1)*255,elevation:s.elevation});return z(a),[a]},he=(o,s,t)=>{var a,n;let e=[],r=t?s.fillColor:s.color,i=new u.default.DbHatch({color:r?parseInt(r.substring(1),16):0,points:o.length==1?o[0]:o,pattern:"SOLID",alpha:((a=s.opacity)!=null?a:1)*255});if(z(i),e.push(i),!t&&!s.noneOutline&&s.color!=s.outlineColor){let l=new u.default.Db2dPolyline({color:s.outlineColor?parseInt(s.outlineColor.substring(1),16):0,points:o,alpha:((n=s.opacity)!=null?n:1)*255});z(l),e.push(l)}return e},Ar=(o,s,t)=>{const e=s.text_size_zoom1?t.pixelToGeoLength(s.text_size_zoom1,1):t.getGeoBounds().height()/80;o[1]-=e/2;const r=new u.default.DbMText({color:s.color?parseInt(s.color.substring(1),16):0,location:[o[0],o[1]],attachment:2,contents:s.text,rotation:u.default.degreesToRadians(-parseFloat(s.text_rotate)),textHeight:e});return z(r),[r]},ge=(o,s,t)=>{var f,y;let e=s.export||{};if(!e.refCo1||!e.refCo2||!e.height||!e.position)return;let r,i,a,n,l;if(o.geometry.type=="Polygon")n=o.geometry.coordinates[0][0],l=o.geometry.coordinates[o.geometry.coordinates.length-1][1];else if(o.geometry.type=="MultiPolygon"){n=o.geometry.coordinates[0][0][0];let m=o.geometry.coordinates[o.geometry.coordinates.length-1];l=m[m.length-1][1]}else if(o.geometry.type=="MultiLineString")n=o.geometry.coordinates[0][0],l=o.geometry.coordinates[o.geometry.coordinates.length-1][1];else if(o.geometry.type=="GeometryCollection"){let m=o.geometry.geometries[0];m.type=="LineString"?n=m.coordinates[0]:m.type=="Polygon"&&(n=m.coordinates[0][0]);let w=o.geometry.geometries[o.geometry.geometries.length-1];w.type=="LineString"?l=w.coordinates[1]:w.type=="Polygon"&&(l=w.coordinates[w.coordinates.length-1][1])}if(!n||!l)return;let c=u.default.coordTransfromGetFourParamter([u.default.geoPoint(e.refCo1),u.default.geoPoint(e.refCo2)],[u.default.geoPoint(n),u.default.geoPoint(l)],!1,!0),h=u.default.coordTransfromByFourParamter(u.default.geoPoint(e.position),c);r=h.x,i=h.y,a=e.height*c.scale;let d,g={...e,rotation:((f=c.rotate)!=null?f:0)+((y=e.textRotate)!=null?y:0),color:s.color?parseInt(s.color.substring(1),16):0};return e.isMText?d=new u.default.DbMText({...g,location:[r,i],textHeight:a}):d=new u.default.DbText({...g,position:[r,i],height:a}),z(d),[d]},wr=(o,s,t,e)=>{const r=o[0],i=o[o.length/2],a=new u.default.DbCircle({color:s.color?parseInt(s.color.substring(1),16):0,center:[(r[0]+i[0])/2,(r[1]+i[1])/2],radius:u.default.geoPoint(r).distanceTo(u.default.geoPoint(i))/2,lineWidth:t,alpha:(e!=null?e:1)*255});return z(a),[a]},z=o=>((o.color==0||o.color==16777215)&&(o.colorIndex=7,delete o.color),o),it=async(o,s,t)=>{var g,f,y,m;let e=s.getAll();e=o.fromLngLat(e);const i=o.getGeoBounds().width()/200;let a=[];for(let w=0;w<e.features.length;w++){let p=e.features[w];if($(p)){const b=R(s,"deleteEntitys");b&&Array.from(new Set(b)).forEach(D=>{a.push({objectid:D,delete:!0})});continue}if(p.geometry.type=="Point")a.push(...de(p.geometry.coordinates,p.properties,i,!1,o));else if(p.geometry.type=="LineString")a.push(...fe(p.geometry.coordinates,p.properties));else if(p.geometry.type=="Polygon"){if((g=p.properties.export)!=null&&g.contents){const b=ge(p,p.properties);if(b&&b.length>0){a.push(...b);continue}}a.push(...he(p.geometry.coordinates,p.properties))}else if(p.geometry.type=="MultiPoint")for(let b of p.geometry.coordinates)a.push(...de(b,p.properties,i,!1,o));else if(p.geometry.type=="MultiLineString"){if((f=p.properties.export)!=null&&f.contents){const b=ge(p,p.properties);if(b&&b.length>0){a.push(...b);continue}}for(let b of p.geometry.coordinates)a.push(...fe(b,p.properties))}else if(p.geometry.type=="MultiPolygon"){if((y=p.properties.export)!=null&&y.contents){const b=ge(p,p.properties);if(b&&b.length>0){a.push(...b);continue}}for(let b of p.geometry.coordinates)a.push(...he(b,p.properties))}else if(p.geometry.type=="GeometryCollection"){if((m=p.properties.export)!=null&&m.contents){const b=ge(p,p.properties);if(b&&b.length>0){a.push(...b);continue}}for(let b=0;b<p.geometry.geometries.length;b++){let D=p.geometry.geometries[b];if(D.type=="Polygon")a.push(...he(D.coordinates,p.properties,!0));else if(D.type=="MultiPolygon")for(let C of D.coordinates)a.push(...he(C,p.properties,!0))}for(let b=0;b<p.geometry.geometries.length;b++){let D=p.geometry.geometries[b];if(D.type=="Point")a.push(...de(D.coordinates,p.properties,i,!0,o));else if(D.type=="LineString")a.push(...fe(D.coordinates,p.properties,!0));else if(D.type=="MultiPoint")for(let C of D.coordinates)a.push(...de(C,p.properties,i,!0,o));else if(D.type=="MultiLineString")for(let C of D.coordinates)a.push(...fe(C,p.properties,!0))}}else console.warn("unknow FeatureCollection type:"+p.geometry.type)}let n=new u.default.DbDocument,l=o.getService(),c=l.currentMapParam();c!=null&&c.mapid&&(c.maptype||(n.from=`${c==null?void 0:c.mapid}/${c==null?void 0:c.version}`)),n.appendEntity(a);let h=new u.default.Service(l.serverUrl,l.accessToken);return l.getCurWorkspaceName()&&h.switchWorkspace(l.getCurWorkspaceName()),await h.updateMap({mapid:t||"draw"+(c==null?void 0:c.mapid),filedoc:n.toDoc(),mapopenway:u.default.MapOpenWay.Memory,style:{backcolor:0}})},$=o=>o?o.id=="__data_track__":!1,ze=(o,s)=>{let e=o.getAll().features.find(r=>$(r));if(!e)o.add({id:"__data_track__",type:"Feature",properties:{...s,radius_inactive:1,radius_static:1,opacity:0,_hover_opacity:0,isOff:!0,isLocked:!0},geometry:{coordinates:[0,0],type:"Point"}});else if(e!=null&&e.id)for(let r in s)o.setFeatureProperty(e==null?void 0:e.id,r,s[r])},R=(o,s)=>{let e=o.getAll().features.find(r=>$(r));if(e&&e.properties)return s?e.properties[s]:e.properties},ye=(o,s)=>{let t={};if(s.features.length>0){let e=s.features[0];e.geometry.type=="Polygon"?t.refCo1=o.fromLngLat(e.geometry.coordinates[0][0]):e.geometry.type=="LineString"&&(t.refCo1=o.fromLngLat(e.geometry.coordinates[0])),e=s.features[s.features.length-1],e.geometry.type=="Polygon"?t.refCo2=o.fromLngLat(e.geometry.coordinates[e.geometry.coordinates.length-1][1]):e.geometry.type=="LineString"&&(t.refCo2=o.fromLngLat(e.geometry.coordinates[1]))}return t},Ue=(o,s,t)=>{const e=s!=null?s:"myhighlight";t=t!=null?t:"#FF8957",o.addGeoJSONSource(`${e}-source`,{type:"FeatureCollection",features:[]}),o.addCircleLayer(`${e}-point-layer`,`${e}-source`,{circleColor:t,circleOpacity:.8,circleRadius:5,filter:["==",["geometry-type"],"Point"]}),o.addLineLayer(`${e}-line-layer`,`${e}-source`,{lineJoin:"round",lineCap:"round",lineColor:t,lineWidth:3,lineOpacity:.8,filter:["==",["geometry-type"],"LineString"]}),o.addFillLayer(`${e}-fill-layer`,`${e}-source`,{fillColor:t,fillOpacity:1,filter:["==",["geometry-type"],"Polygon"]})},ee=(o,s)=>{const t=s!=null?s:"myhighlight";o.getSource(`${t}-source`)&&o.getSource(`${t}-source`).setData({type:"FeatureCollection",features:[]})},br=async(o,s,t,e)=>{const r=o.getService(),i=s&&u.default.geoPoint([s[0],s[1]]).equals(u.default.geoPoint([s[2],s[3]]));let a;if(i)a=await r.pointQueryFeature({zoom:o.getZoom(),x:s[0],y:s[1],...t,fields:"objectid"});else{const d=[];let g=0;const f=5e4;for(;;){const y=await r.conditionQueryFeature({condition:"",bounds:s,fields:"objectid",includegeom:!0,realgeom:!0,isContains:s&&s[0]>s[2],beginpos:g,limit:f,...t});if(!y.result||(g+=f,d.push(...y.result||[]),d.length>=y.recordCount))break}a={result:d,recordCount:d.length}}let n=new Set,l=new Set;if(a.result){for(const d of a.result)if(d.objectid){if(e&&e.has(d.objectid)){l.add("1 != 1");continue}let g="",f=0;for(f=0;f<d.objectid.length&&ne(d.objectid[f]);f++)g+=d.objectid[f];if(g)if(g==d.objectid)n.add(g);else{const y=["_"];for(const m of y)l.add(`objectid like '${g}${m}%'`)}}}let c,h;return n.size>0&&(c=` objectid in (${Array.from(n).map(g=>`"${g}"`).join(",")}) `),l.size>0&&(h=Array.from(l).join(" or ")),c&&h?c+" or "+h:c||(h!=null?h:"")},_e=async(o,s,t,e,r,i,a,n,l)=>{var w,p,b,D;const c=n!=null?n:"myhighlight",h=o.getService(),d=s&&u.default.geoPoint([s[0],s[1]]).equals(u.default.geoPoint([s[2],s[3]]));let g;r&&(g=await br(o,s,e,i));let f;if(d&&!g)f=await h.pointQueryFeature({zoom:o.getZoom(),x:s[0],y:s[1],...e});else{let C=[],v=0;const S=5e4;for(;;){let x;if(g?x=await h.conditionQueryFeature({condition:g,fields:"",includegeom:!0,realgeom:!0,beginpos:v,limit:S,...e}):x=await h.conditionQueryFeature({condition:"",bounds:s,fields:"",includegeom:!0,realgeom:!0,isContains:s&&s[0]>s[2],beginpos:v,limit:S,...e}),!x.result||(v+=S,C.push(...x.result||[]),C.length>=x.recordCount))break}f={result:C,recordCount:C.length}}i&&f.result&&(f.result=f.result.filter(C=>!i.has(C.objectid)),f.recordCount=f.result.length);const y={features:[],type:"FeatureCollection"},m={features:[],type:"FeatureCollection"};if(f&&f.result&&f.result.length>0){o.getSource(`${c}-source`)||Ue(o,n,l);for(const v of f.result){if(v.geom&&v.geom.geometries)for(const S in v.geom.geometries){const x={type:"Feature",id:v.id+"_"+S,properties:V(v),geometry:v.geom.geometries[S]};y.features.push(x)}if(!t){const S=v.points||v.positon||v.location||v.origin||v.center;if(S){const T=S.split(";").map(I=>o.toLngLat(u.default.GeoPoint.fromString(I)));if(T.length==1){const I={type:"Feature",id:v.id,properties:V(v),geometry:{type:"Point",coordinates:T[0]}};m.features.push(I)}else if(T.length>1){const I={type:"Feature",id:v.id,properties:V(v),geometry:{type:"LineString",coordinates:T}};m.features.push(I)}}}}const C=t?y:m;C.features.length>0?!a&&((p=(w=o.getSource(`${c}-source`))==null?void 0:w._data)==null?void 0:p.features)?o.getSource(`${c}-source`).setData({features:[...(D=(b=o.getSource(`${c}-source`))==null?void 0:b._data)==null?void 0:D.features,...C.features],type:"FeatureCollection"}):o.getSource(`${c}-source`).setData(C):a&&ee(o,c)}else a&&ee(o,c);return o.triggerRepaint(),t?y:m},me=(o,s)=>{const t=s!=null?s:"myhighlight";ee(o,t),o.triggerRepaint()},pe={},Ae=async(o,s,t)=>{var l,c;if(t===0){s.features=[];return}const e=o.getService(),r=(l=e.currentMapParam())==null?void 0:l.mapid,i=(c=e.currentMapParam())==null?void 0:c.version;if(!r)return;const a=`${r}_${i}${e.getCurWorkspaceName()}`;if(a in pe){s.features=[...pe[a].features];return}else{const h=localStorage.getItem("snap_"+a);if(h)try{const d=JSON.parse(h);if(Array.isArray(d)){s.features=[...d],pe[a]=s;return}}catch{}}let n=await e.conditionQueryFeature({fields:"s3",condition:"s3 != ''",limit:t!=null?t:1e5});if(!!n.result){n=n.result.map(h=>h.s3.split(";")),s.features=[];for(const h of n){const d=[];for(const g of h){const f=g.split(",");f.length>=2&&d.push(o.toLngLat([+f[0],+f[1]]))}d.length==1?s.features.push({type:"Feature",geometry:{type:"Point",coordinates:d[0]}}):d.length>1&&s.features.push({type:"Feature",geometry:{type:"LineString",coordinates:d}})}pe[a]=s;try{localStorage.setItem("snap_"+a,JSON.stringify(s.features))}catch{}}},Ze=async(o,s,t,e,r,i)=>{var n;if(((n=o.getService().currentMapParam())==null?void 0:n.mapopenway)==u.default.MapOpenWay.Memory){console.error("\u5185\u5B58\u6253\u5F00\u6A21\u5F0F\u4E0D\u652F\u6301\u9009\u62E9\u5B9E\u4F53\uFF0C\u8BF7\u5207\u6362\u81F3\u51E0\u4F55\u6805\u683C\u6216\u51E0\u4F55\u77E2\u91CF\u65B9\u5F0F\u6253\u5F00\u56FE\u5F62");return}const a={};for(r||Ae(o,a),o._selectFeatures=[];;){let l;if(e!=null?e:o._isPointSel){const h=await u.default.Draw.actionDrawPoint(o,{api:{getSnapFeatures:a},contextMenu:d=>{o.fire("keyup",{keyCode:13})}});if(h.cancel)break;l=[h.features[0].geometry.coordinates,h.features[0].geometry.coordinates,h.features[0].geometry.coordinates,h.features[0].geometry.coordinates]}else{const h=await u.default.Draw.actionDrawRectangle(o,{api:{getSnapFeatures:a},contextMenu:d=>{o.fire("keyup",{keyCode:13})}});if(h.cancel)break;l=h.features[0].geometry.coordinates[0]}l=o.fromLngLat(l);const c=await _e(o,[l[0].x,l[0].y,l[2].x,l[1].y],s,void 0,t!=null?t:o._includeWholeEntity,i);o._selectFeatures.push(...c.features)}return o._selectFeatures},we=async(o,s,t,e,r,i)=>{r&&r(`\u8BF7\u9009\u62E9\u8981${e?"\u5220\u9664":"\u4FEE\u6539"}\u7684CAD\u5B9E\u4F53\u5BF9\u8C61\uFF0C\u6309\u53F3\u952E\u7ED3\u675F`);const a=R(s,"hideEntityObjectIds"),n=await Ze(o,!0,!0,!0,!0,a?new Set(a):void 0);if(!n||n.length==0)return;const l=new Set,c=new Set,h=new Set;n.forEach(f=>{f.properties.objectid&&c.add(f.properties.objectid),f.id&&h.add(parseInt(f.id));const y=le(f.properties.objectid);y&&l.add(y)});const d=async f=>{o.hasVectorLayer()?await t.addHideObjectIds(Array.from(h)):await t.addHideObjectIds(Array.from(c));const y=R(s,"deleteEntitys")||[];y.push(...Array.from(l));const m=R(s,"hideEntityObjectIds")||[];m.push(...Array.from(c));const w=R(s,"hideEntityIds")||[];if(w.push(...Array.from(c)),ze(s,{deleteEntitys:Array.from(new Set(y)),hideEntityObjectIds:Array.from(new Set(m)),hideEntityIds:Array.from(new Set(w))}),!e){let p=o.getService().currentMapParam();const b=await j(o,Array.from(l).map(D=>({objectid:D,...f})),t==null?void 0:t.getClipBounds(),null,null,`${p.mapid}/${p.version}`);if(N(b,s),(f==null?void 0:f.isText)||(f==null?void 0:f.isMText)){const D=s.getAll().features,C=D[D.length-1].id;s.setFeatureProperty(C,"export",{...f.export,...ye(o,b)})}}me(o)},g=()=>{me(o)};if(!e&&l.size==1&&(n[0].properties.name=="AcDbText"||n[0].properties.name=="AcDbMText")){const f=prompt("\u8BF7\u8F93\u5165\u8981\u4FEE\u6539\u7684\u6587\u5B57\u5185\u5BB9",n[0].properties.text);if(f==""||f==null){g();return}else{const y=n[0].properties,w=y.name=="AcDbText"?{text:f,isText:!0}:{contents:f,isMText:!0};w.export={position:u.default.GeoPoint.fromString(y.location||y.position),height:y.height||y.textHeight,contents:f,cloneObjectId:le(y.objectid),textRotate:y.rotate||0},await d(w)}}else i?await i(`\u4F60\u786E\u5B9A\u8981${e?"\u5220\u9664":"\u4FEE\u6539"} \u8FD9 ${l.size} \u4E2Acad\u5B9E\u4F53\u5BF9\u8C61 ?`)?await d():g():await d()},ot=async(o,s,t,e,r)=>{await we(o,s,t,!0,e,r)},at=async(o,s,t,e,r)=>{await we(o,s,t,!1,e,r)},j=async(o,s=[],t=null,e=null,r=null,i=null)=>{let a=new u.default.DbDocument;e&&(a.environment=e),r&&(a.linetypes=r);let n=o.getService().currentMapParam();t?i&&(a.from=i,a.pickEntitys=s.map(d=>d.objectid)):(i?a.from=`${i.mapid}/${i.version}`:a.from=`${n.mapid}/${n.version}`,a.pickEntitys=s.map(d=>d.objectid)),a.appendEntity(s);let c=await o.getService().cmdCreateEntitiesGeomData({filedoc:a.toDoc(),mapBounds:t||n.bounds.toArray()});const h=[];if(c&&c.result&&c.result.length>0){for(let d of c.result)if(d.geom&&d.geom.geometries){let g=o.entColorToHtmlColor(d.color);for(let f=0;f<d.geom.geometries.length;f++){let y={};d.isPolygon?(y.color=g,y.noneOutline=!0):(y.color=g,y.line_width=d.lineWidth),h.push({id:u.default.RandomID(10),type:"Feature",properties:{objectid:d.objectid+"_"+f,opacity:d.alpha/255,...y},geometry:d.geom.geometries[f]})}}}return{type:"FeatureCollection",features:h}},nt=async(o,s,t,e)=>{if(t=JSON.parse(t),s.set(o.toLngLat(t)),o.hasVectorLayer()){const r=R(s,"hideEntityIds")||[];r&&await e.addHideObjectIds(r)}else{const r=R(s,"hideEntityObjectIds")||[];r&&await e.addHideObjectIds(r)}},M=(o,s)=>{if(!!s)for(let t in s)o.properties[t]=s[t]},lt=o=>{o.fire("keyup",{keyCode:27})},ut=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawPoint(o,t);r.cancel||(M(r.features[0],e),s.add(r.features[0]))},ct=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawLineSting(o,t);r.cancel||(M(r.features[0],e),s.add(r.features[0]))},dt=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawPolygon(o,t);r.cancel||(M(r.features[0],e),s.add(r.features[0]))},ft=async(o,s,t,e)=>{let r=await u.default.Draw.actionDrawPolygon(o,t);r.cancel||(M(r.features[0],e),s.add(r.features[0]))},te=o=>{if(o.geometry.type=="Polygon")return o.geometry.type="LineString",o.geometry.coordinates=o.geometry.coordinates[0],o},ht=async(o,s,t,e,r)=>{let i=await u.default.Draw.actionDrawCircle(o,t);i.cancel||(M(i.features[0],e),r||(i.features[0]=te(i.features[0]),M(i.features[0],{isCircle:void 0})),s.add(i.features[0]))},gt=async(o,s,t,e,r)=>{let i=await u.default.Draw.actionDrawRectangle(o,t);i.cancel||(M(i.features[0],e),r||(i.features[0]=te(i.features[0])),s.add(i.features[0]))},yt=async(o,s,t,e,r)=>{let i=await u.default.Draw.actionDrawSlantRectangle(o,t);i.cancel||(M(i.features[0],e),r||(i.features[0]=te(i.features[0])),s.add(i.features[0]))},mt=async(o,s,t,e)=>{let r=await u.default.Draw.actionSelect(o,s);if(r.features.length==0)return;e&&e("\u8BF7\u6307\u5B9A\u7684\u65CB\u8F6C\u7684\u57FA\u70B9");let i=await u.default.Draw.actionDrawPoint(o,{});if(i.cancel)return;e&&e("\u8BF7\u6307\u5B9A\u8981\u65CB\u8F6C\u7684\u89D2\u5EA6");let a=i.features[0].geometry.coordinates,n=a,l=new u.default.Polyline({data:[a,n],lineColor:"yellow",lineWidth:1,lineDasharray:[2,2]});l.addTo(o);let c=u.default.cloneDeep(r.features),h=await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:d=>{if(!d.lnglat)return;n=d.lnglat,l.setData([a,n]);let g=o.fromLngLat(n).angleTo(o.fromLngLat(a)),f=u.default.cloneDeep(c);for(let y=0;y<f.length;y++){let m=u.default.transform.convert(f[y],w=>{let b=o.fromLngLat(w).roateAround(g,o.fromLngLat(a));return o.toLngLat(b)});s.setFeatureProperty(f[y].id,"coordinates",m)}s.forceRefresh()}});if(l.remove(),h.cancel){for(let d=0;d<c.length;d++)s.setFeatureProperty(c[d].id,"coordinates",c[d]);s.forceRefresh();return}},pt=(o,s)=>{let t=s.getSelected().features.filter(i=>i.geometry.type=="LineString"||i.geometry.type=="Polygon");if(t.length==0)return;let e=u.default.cloneDeep(t);for(let i=0;i<t.length;i++){let a=t[i];if(a.geometry.type=="LineString"){const n=u.default.polylineToBezierCurve(o.fromLngLat(a.geometry.coordinates).map(c=>[c.x,c.y])),l=u.default.bezierCurveToPolyline(n,100);s.setFeatureProperty(a.id,"coordinates",o.toLngLat(l))}else{let n=[];for(let l=0;l<a.geometry.coordinates.length;l++){const c=u.default.polylineToBezierCurve(o.fromLngLat(a.geometry.coordinates[l]).map(d=>[d.x,d.y])),h=u.default.bezierCurveToPolyline(c,1e3);n.push(o.toLngLat(h))}s.setFeatureProperty(a.id,"coordinates",n)}}let r=s.getSelected().features.filter(i=>i.geometry.type=="LineString"||i.geometry.type=="Polygon");o.fire("draw.update",{action:"toBezierCurve",features:u.default.cloneDeep(r),prevFeatures:e,styleId:s.options.styleId}),s.changeMode("simple_select")},be=async(o,s,t,e,r,i,a)=>{var m,w,p,b,D;let n=await u.default.Draw.actionDrawPoint(o,{...t});if(n.cancel)return;let l=o.fromLngLat(n.features[0].geometry.coordinates),c;if(i?c=new u.default.EllipseFill({center:l,majorAxisRadius:0,minorAxisRadius:0,fillColor:(m=e==null?void 0:e.color)!=null?m:"green",fillOpacity:(w=e==null?void 0:e.opacity)!=null?w:.8,fillOutlineColor:(p=e==null?void 0:e.outlineColor)!=null?p:"#f00"}):c=new u.default.EllipseEdge({center:l,majorAxisRadius:0,minorAxisRadius:0,lineColor:(b=e==null?void 0:e.outlineColor)!=null?b:"red",lineWidth:(D=e==null?void 0:e.line_width)!=null?D:3}),c.addTo(o),(await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:C=>{if(!C.lnglat)return;const v=o.fromLngLat(C.lnglat);c.setMinorAxisRadius(l.distanceTo(v)),c.setMajorAxisRadius(l.distanceTo(v))}})).cancel){c.remove();return}if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:C=>{if(!C.lnglat)return;const v=o.fromLngLat(C.lnglat);c.setMinorAxisRadius(l.distanceTo(v))}})).cancel){c.remove();return}if(a){if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:S=>{if(!S.lnglat)return;const x=o.fromLngLat(S.lnglat);c.setStartAngle(u.default.radiansToDegrees(x.angleTo(l)))}})).cancel){c.remove();return}if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:S=>{if(!S.lnglat)return;const x=o.fromLngLat(S.lnglat);c.setEndAngle(u.default.radiansToDegrees(x.angleTo(l)))}})).cancel){c.remove();return}}let g=c.getData();if((await u.default.Draw.actionDrawPoint(o,{...t,updatecoordinate:C=>{if(!C.lnglat)return;let S=o.fromLngLat(C.lnglat).angleTo(l),x=u.default.cloneDeep(g),T;i?T=x.features[0].geometry.coordinates[0]:T=x.features[0].geometry.coordinates;for(let I=0;I<T.length;I++){let Z=o.fromLngLat(T[I]);Z=Z.roateAround(S,l),Z=o.toLngLat(Z),T[I]=Z}c.setData(x)}})).cancel){c.remove();return}let y=c.getData().features[0];y.id=u.default.RandomID(10),y.properties={...e},s.add(y),c.remove()},At=(o,s,t,e,r)=>{be(o,s,t,e,r,!0)},wt=(o,s,t,e,r)=>{be(o,s,t,e,r,!1)},bt=(o,s,t,e,r)=>{be(o,s,t,e,r,!0,!0)},Lt=(o,s,t,e,r)=>{be(o,s,t,e,r,!1,!0)},Le=o=>{let s=[];u.default.transform.convert(o,e=>(s.push(u.default.geoPoint(e)),e));let t=new u.default.GeoBounds;return t.update(s),t},re=async(o,s,t,e,r)=>{var n,l;const i=s.createDrawLayer();r=r!=null?r:{};const a=()=>{i&&s.removeDrawLayer(i),s.setIsInteracting(!1)};try{let c=Le(o),h=s.fromLngLat(s.getCenter()),d=s.pixelToGeoLength((n=r.drawInitPixelLength)!=null?n:100,s.getZoom()),g=s.fromLngLat(c),f=d/g.width(),y=d/g.height(),m=Math.min(f,y),w=c.center();r.baseAlign=="leftBottom"?w=c.min:r.baseAlign=="leftTop"&&(w=u.default.geoPoint([c.min.x,c.max.y]));let p=H(s,u.default.cloneDeep(o),s.fromLngLat(w),h,m),b=s.fromLngLat(Le(p)),D=b.center();r.baseAlign=="leftBottom"?D=b.min:r.baseAlign=="leftTop"&&(D=u.default.geoPoint([b.min.x,b.max.y])),N(p,i),e&&e("\u8BF7\u79FB\u52A8\u9F20\u6807\u81F3\u6307\u5B9A\u4F4D\u7F6E\u70B9\u51FB\u8FDB\u884C\u7ED8\u5236"),s.setIsInteracting(!0);let C=u.default.cloneDeep(i.getAll()),v=await u.default.Draw.actionDrawPoint(s,{...t,updatecoordinate:J=>{if(!J.lnglat)return;i.deleteAll();const Y=s.fromLngLat(J.lnglat);let ie=H(s,u.default.cloneDeep(C),D,Y);i.set(ie)}});if(v.cancel){a();return}let S=s.fromLngLat(v.features[0].geometry.coordinates),x=new u.default.Polyline({data:s.toLngLat([S,S]),lineColor:(l=r.tempLineColor)!=null?l:"yellow",lineWidth:1,lineDasharray:[2,2]});x.addTo(s);let T=1;if(!r.disableScale){let J=await u.default.Draw.actionDrawPoint(s,{...t,updatecoordinate:ve=>{if(i.deleteAll(),!ve.lnglat)return;const Rt=s.fromLngLat(ve.lnglat);let Rr=Rt.distanceTo(S)/(b.width()/2),Vr=H(s,u.default.cloneDeep(C),D,S,Rr);i.set(Vr),x.setData(s.toLngLat([S,Rt]))}});if(J.cancel){a(),x.remove();return}T=s.fromLngLat(J.features[0].geometry.coordinates).distanceTo(S)/(b.width()/2),T<1e-4&&(T=.1),x.setData(s.toLngLat([S,S]))}let I=0;if(!r.disableRotate){let J=await u.default.Draw.actionDrawPoint(s,{...t,updatecoordinate:Y=>{if(i.deleteAll(),!Y.lnglat)return;const ie=s.fromLngLat(Y.lnglat);I=ie.angleTo(S)*180/Math.PI;let ve=H(s,u.default.cloneDeep(C),D,S,T,I);i.set(ve),x.setData(s.toLngLat([S,ie]))}});if(x.remove(),J.cancel){I=0;let Y=H(s,u.default.cloneDeep(C),D,S,T,I);i.set(Y)}}s.setIsInteracting(!1);let Z=i.getAll();return s.removeDrawLayer(i),{feature:Z,rotation:I}}catch{a()}},vt=async(o,s,t,e,r,i)=>{var p,b,D,C,v,S,x,T;i=i||{};let a=new u.default.DbLineType;a.name="my_arrow_dash",a.comments="\u865A\u7EBF",a.style=[{method:"numDashes",parameter:4},{method:"patternLength",parameter:1},{method:"dashLengthAt",parameter:[0,.5]},{method:"dashLengthAt",parameter:[1,-.2]},{method:"dashLengthAt",parameter:[2,.1]},{method:"dashLengthAt",parameter:[3,-.2]}];let n=[],l=(p=i.arrowShape)!=null?p:[[10,60],[150,20],[140,40],[190,0],[140,-40],[150,-20],[10,-40],[10,60]],h=u.default.getGeoBounds(l.map(I=>u.default.geoPoint(I))).scale(3).toArray(),d=new u.default.DbPolyline;d.lineWidth=(b=i.lineWidth)!=null?b:50,d.points=l,i.noLineType||(d.linetype="my_arrow_dash",d.linetypeScale=30),d.color=o.htmlColorToEntColor((D=e==null?void 0:e.outlineColor)!=null?D:u.default.randomColor());let g=(C=e==null?void 0:e.color)!=null?C:u.default.randomColor(),f=new u.default.DbHatch;if(f.pattern="SOLID",f.color=o.htmlColorToEntColor(g),f.points=l,f.alpha=100*((v=e==null?void 0:e.opacity)!=null?v:1),n.push(d,f),!i.noText){let I=new u.default.DbText({position:(S=i.textPositon)!=null?S:[100,70],contents:(x=i.contents)!=null?x:"\u7BAD\u5934",color:o.htmlColorToEntColor(g),horizontalMode:4,height:(T=i.textHeight)!=null?T:20});n.push(I)}let m=await j(o,n,h,{LWDISPLAY:!0},[a]),w=await re(m,o,t,r);!w||s.add(w==null?void 0:w.feature)},Dt=async(o,s,t,e,r,i)=>{var c,h,d,g,f;i=i||{};let a=await u.default.Draw.actionDrawLineSting(o,{...t});if(a.cancel)return;let n=o.fromLngLat(a.features[0].geometry.coordinates),l=new u.default.DbPolyline;if(l.objectid=(c=i.objectid)!=null?c:"40D",l.color=u.default.htmlColorToEntColor((h=e==null?void 0:e.color)!=null?h:u.default.randomColor()),l.linetypeScale=(d=i.linetypeScale)!=null?d:100,l.points=n.map(y=>[y.x,y.y]),l){let y=await j(o,[l],null,null,null,{mapid:(g=i.mapid)!=null?g:"sys_symbols",version:(f=i.version)!=null?f:"v1"});N(y,s)}},Lr=(o,s,t)=>{let e=null,r=new Date;return function(){let i=this,a=arguments,n=new Date;clearTimeout(e),n-r>=t?(o.apply(i,a),r=n):e=setTimeout(function(){o.apply(i,a)},s)}},Ct=async(o,s,t,e,r,i)=>{var g;i=i!=null?i:{};let a=u.default.htmlColorToEntColor((g=e==null?void 0:e.color)!=null?g:u.default.randomColor());const n=async(f,y)=>{var w,p,b,D;let m={};if(m.objectid=(w=i==null?void 0:i.objectid)!=null?w:"40E",m.color=y,m.linetypeScale=(p=i==null?void 0:i.linetypeScale)!=null?p:100,m.fitPoints=f.map(C=>[C.x,C.y]),m)return await j(o,[m],null,null,null,{mapid:(b=i==null?void 0:i.mapid)!=null?b:"sys_symbols",version:(D=i==null?void 0:i.version)!=null?D:"v1"})};let l=o.createDrawLayer(),c=await u.default.Draw.actionDrawLineSting(o,{...t,updatecoordinate:Lr(async f=>{let y=o.fromLngLat(f.feature.coordinates),m=await n(y,a);l&&l.set(m)},200,300)});if(o.removeDrawLayer(l),l=null,c.cancel)return;let h=o.fromLngLat(c.features[0].geometry.coordinates),d=await n(h,a);d&&N(d,s)},St=async(o,s,t,e,r,i)=>{var c,h,d,g,f;i=i!=null?i:{};let a=await u.default.Draw.actionDrawPolygon(o,{...t});if(a.cancel)return;let n=o.fromLngLat(a.features[0].geometry.coordinates[0]),l=new u.default.DbHatch;if(l.objectid=(c=i.objectid)!=null?c:"42F",l.color=u.default.htmlColorToEntColor((h=e==null?void 0:e.color)!=null?h:u.default.randomColor()),l.patternScale=(d=i.patternScale)!=null?d:400,l.points=n.map(y=>[y.x,y.y]),l){let y=await j(o,[l],null,null,null,{mapid:(g=i.mapid)!=null?g:"sys_symbols",version:(f=i.version)!=null?f:"v1"});N(y,s)}},vr=async(o,s,t)=>{t=t!=null?t:{};let e=await o.getService().conditionQueryFeature({fields:"",includegeom:!0,realgeom:!0,limit:1e4,...s});const r=[];if(e&&e.result&&e.result.length>0){for(let i of e.result)if(i.geom&&i.geom.geometries){let a=o.entColorToHtmlColor(i.color);for(let n=0;n<i.geom.geometries.length;n++)r.push({id:u.default.RandomID(10),type:"Feature",properties:{objectid:i.objectid+"_"+n,color:a,alpha:i.alpha/255,lineWidth:1,name:i.name,isline:i.isline,layerindex:i.layerindex,...t},geometry:i.geom.geometries[n]})}}return{type:"FeatureCollection",features:r}},kt=async(o,s,t,e,r,i)=>{var y,m,w;i=i!=null?i:{},r&&r("\u8BF7\u79FB\u52A8\u9F20\u6807\u5C06\u8981\u7ED8\u5236\u7684\u7B26\u53F7\u79FB\u52A8\u81F3\u6307\u5B9A\u4F4D\u7F6E\u70B9\u51FB\u8FDB\u884C\u7ED8\u5236");let a=(y=i.mapid)!=null?y:"sys_symbols",n=(m=i.version)!=null?m:"v1",c=await o.getService().getStyleLayerName(a,n,!0),h=await vr(o,{mapid:a,version:n,layer:c,condition:(w=i.condition)!=null?w:"layerindex=1"},{symbolId:u.default.RandomID()}),d=await re(h,o,t,r,{baseAlign:"center"});if(!d)return;N(d.feature,s);let g=s.getAll().features,f=g[g.length-1].id;for(let p in e)s.setFeatureProperty(f,p,e[p])},xt=async(o,s,t,e,r)=>{var f,y;if(e=e||{},!e.text)return;let i=[-1e3,-1e3,1e3,1e3],a=[],n={position:[0,0],contents:e.text,color:o.htmlColorToEntColor(e.color),horizontalMode:u.default.DbTextHorzMode.kTextLeft,verticalMode:u.default.DbTextVertMode.kTextBottom,height:10},l=new u.default.DbText(n);a.push(l);let c=await j(o,a,i);const h=new u.default.GeoProjection(u.default.GeoBounds.fromArray(i));let d=ye(h,c);n={...n,...d};let g=await re(c,o,t,r,{baseAlign:"leftBottom",drawInitPixelLength:(f=e.height)!=null?f:50,disableRotate:e==null?void 0:e.disableRotate,disableScale:e==null?void 0:e.disableScale});!g||(g.feature.features[0].properties=(y=g.feature.features[0].properties)!=null?y:{},g.feature.features[0].properties.export=n,s.add(g.feature))},N=(o,s)=>{let t=[];return o.features.forEach(e=>{t.push(...s.add(e))}),s.changeMode("simple_select",{featureIds:t}),s.combineFeatures(),t.length},It=async(o,s,t)=>{let e=o.getService();if(t){let r=s.reduce((i,a)=>(a.isOff||i.push(a.name),i),[]);Je(o,r)}else await o.switchLayers(e,s.reduce((r,i)=>(i.isOff||r.push(i.name),r),[]))},Je=(o,s)=>{debugger;const t=c=>i.getMapLayers().findIndex(h=>h.name===c),e=(c,h)=>{Array.isArray(c)||(c=[c]);let d=[];return h||(d=c.map(g=>t(g))),d.length==0&&(d=[-1]),["match",["get","layer"],d,!0,!1]};let r=o.getStyle(),i=o.getService(),n=i.vectorStyle().layers.map(c=>c.id),l=e(s,!1);for(let c=0;c<r.layers.length;c++)n.includes(r.layers[c].id)&&(r.layers[c].filter=l);o.setStyle(r)},Tt=(o,s,t)=>{if(o.hasVectorLayer()){const e=o.layersBySource("vector-source");for(let r of e){const i=o.getLayer(r);i.type=="fill"?o.setFillOpacity(r,s):i.type=="line"?o.setLineOpacity(r,s):i.type=="circle"&&o.setCircleOpacity(r,s)}}if(t){const r=o.getStyle().layers.filter(i=>i.id.indexOf(t)>=0);for(let i of r)o.setRasterOpacity(i.id,s)}else{const e=o.getService().rasterLayerId();o.getLayer(e)&&o.setRasterOpacity(o.getService().rasterLayerId(),s)}},Ft=(o,s)=>{const t=o.getStyle().layers;t.length!=0&&o.moveLayer(s,t[0].id)};let U,se;async function Pt(o,s){switch(se=s,s!="measureCancel"&&(await Et(o),U||(U={},Ae(o,U))),s){case"measureDist":Dr(o,U);break;case"measureArea":xr(o,U);break;case"measureAngle":Fr(o,U);break;case"measureCoordinate":Mr(o,U);break;case"measureCancel":await Et(o);break}}const Et=async o=>{o.fire("keyup",{keyCode:27}),await oe(100),o.fire("keyup",{keyCode:27}),await oe(100),o.setIsInteracting(!1)};let _;const F=(o,s)=>{o?_?_.setHTML(o):_=new u.default.Popup({className:"my-custom-popup",closeOnClick:!1,closeButton:!1}).setHTML(o).setMaxWidth("500px").trackPointer().addTo(s):_&&(_.setLngLat([0,0]),_.remove(),_=null)},Dr=async(o,s)=>{for(;!((await Cr(o,s)).exit===!0||se!="measureDist"););},Cr=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawLineSting(o,{api:{getSnapFeatures:s},updatecoordinate:a=>{if(!a.lnglat)return;t=!0;const n=o.fromLngLat(a.feature.coordinates[a.feature.coordinates.length-1]);let l=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u8DDD\u79BB\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${n.x.toFixed(2)}, ${n.y.toFixed(2)}</span>`;if(a.feature.coordinates.length==1)l+="<br/>\u8BF7\u6307\u5B9A\u8981\u6D4B\u91CF\u7684\u7B2C\u4E00\u70B9\u7684\u5750\u6807\u4F4D\u7F6E";else{let c=a.feature.coordinates.length;l+="<br/>\u6309Alt\u952E\u53D6\u6355\u6349; Ctrl\u952E\u542F\u7528\u6B63\u4EA4; \u9000\u683C\u952E\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",l+=`<br/>\u8DDD\u4E0A\u4E00\u70B9\u8DDD\u79BB: <span style="color: #ff0000">${Ye(o,[a.feature.coordinates[c-2],a.feature.coordinates[c-1]])}</span>`,l+=`;  \u5F53\u524D\u603B\u7684\u8DDD\u79BB: <span style="color: #ff0000">${Ye(o,a.feature.coordinates)}</span></span>`}F(l,o)},contextMenu:a=>{new u.default.ContextMenu({event:a.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",onClick:()=>{o.fire("keyup",{keyCode:8})}},{label:"\u7ED3\u675F\u6D4B\u8DDD",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});if(e.cancel)return F("",o),{cancel:!0,exit:t===!1};let r=u.default.randomColor(),i=new u.default.Polyline({data:e.features[0].geometry.coordinates,lineColor:r,lineWidth:2});return i.addTo(o),Sr(o,e.features[0].geometry.coordinates,r,i.sourceId||"",s),{polyline:i}},Sr=(o,s,t,e,r)=>{let i=[];for(let c=1;c<s.length;c++){let h=new u.default.Text({text:Ye(o,s.slice(0,c+1)),anchor:"left",offset:[3,0],style:{cursor:"pointer",opacity:.8,padding:"6px","border-radius":"12px","background-color":t,"border-width":0,"box-shadow":"0px 2px 6px 0px rgba(97,113,166,0.2)","text-align":"center","font-size":"14px",color:`#${t.substring(1).split("").map(d=>(15-parseInt(d,16)).toString(16)).join("")}`}});h.setLngLat(s[c]).addTo(o),i.push(h)}const a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let n=document.createElement("div");n.className="marker",n.style.backgroundImage=`url(${a})`,n.style.width="20px",n.style.height="20px",n.style.backgroundSize="100%",n.style.cursor="pointer",n.addEventListener("click",function(c){o.removeSourceEx(e),i.forEach(h=>h.remove()),i=[],o.fire("keyup",{keyCode:8})});let l=new u.default.Marker({element:n,anchor:"right"});l.setLngLat(s[0]).setOffset([-5,0]).addTo(o),i.push(l),Ke(r,s)},Ye=(o,s)=>{let t=u.default.Math2D.lineDist(o.fromLngLat(s)),e="m";return t>=1e3?(t/=1e3,e="km"):t<.01&&(t*=100,e="cm"),t.toFixed(2)+" "+e},Ke=(o,s)=>{o.features.push({type:"Feature",geometry:{type:"LineString",coordinates:[...s]}})},kr=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawPolygon(o,{api:{getSnapFeatures:s},updatecoordinate:a=>{if(!a.lnglat)return;t=!0;const n=o.fromLngLat(a.feature.coordinates[0][a.feature.coordinates.length-1]);let l=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u9762\u79EF\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${n.x.toFixed(2)}, ${n.y.toFixed(2)}</span>`;a.feature.coordinates[0].length==1?l+="<br/>\u8BF7\u6307\u5B9A\u8981\u6D4B\u91CF\u7684\u7B2C\u4E00\u70B9\u7684\u5750\u6807\u4F4D\u7F6E":(l+="<br/>\u6309Alt\u952E\u53D6\u6355\u6349; Ctrl\u952E\u542F\u7528\u6B63\u4EA4; \u9000\u683C\u952E\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",l+=`<br/>\u5F53\u524D\u9762\u79EF: <span style="color: #ff0000">${Mt(o,a.feature.coordinates[0])}</span></span>`),F(l,o)},contextMenu:a=>{new u.default.ContextMenu({event:a.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",onClick:()=>{o.fire("keyup",{keyCode:8})}},{label:"\u7ED3\u675F\u6D4B\u9762\u79EF",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});if(e.cancel)return F("",o),{cancel:!0,exit:t===!1};let r=u.default.randomColor(),i=new u.default.Polygon({data:e.features[0].geometry.coordinates[0],fillColor:r,fillOpacity:.4,fillOutlineColor:r});return i.addTo(o),Ir(o,e.features[0].geometry.coordinates[0],r,i.sourceId||"",s),{polygon:i}},xr=async(o,s)=>{for(;!((await kr(o,s)).exit===!0||se!="measureArea"););},Ir=(o,s,t,e,r)=>{let i=[];const a=u.default.polygonCentroid(o.fromLngLat(s));let n=new u.default.Text({text:Mt(o,s),anchor:"center",offset:[0,0],style:{cursor:"pointer",opacity:.8,padding:"6px","border-radius":"12px","background-color":`#${t.substring(1).split("").map(d=>(15-parseInt(d,16)).toString(16)).join("")}`,"border-width":0,"box-shadow":"0px 2px 6px 0px rgba(97,113,166,0.2)","text-align":"center","font-size":"14px",color:t}});n.setLngLat(o.toLngLat(a)).addTo(o),i.push(n);const l="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let c=document.createElement("div");c.className="marker",c.style.backgroundImage=`url(${l})`,c.style.width="20px",c.style.height="20px",c.style.backgroundSize="100%",c.style.cursor="pointer",c.addEventListener("click",function(d){o.removeSourceEx(e),i.forEach(g=>g.remove()),i=[]});let h=new u.default.Marker({element:c,anchor:"right"});h.setLngLat(s[0]).setOffset([-5,0]).addTo(o),i.push(h),Ke(r,s)},Mt=(o,s)=>{let t=u.default.calcPolygonArea(o.fromLngLat(s)),e="m\xB2";return t>=1e6?(t/=1e6,e="km\xB2"):t<1/1e4&&(t*=1e4,e="cm\xB2"),t.toFixed(2)+" "+e},Tr=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawLineSting(o,{pointCount:3,api:{getSnapFeatures:s},updatecoordinate:a=>{if(!a.lnglat)return;t=!0;const n=o.fromLngLat(a.feature.coordinates[a.feature.coordinates.length-1]);let l=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u89D2\u5EA6\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${n.x.toFixed(2)}, ${n.y.toFixed(2)}</span>`;a.feature.coordinates.length==1?l+="<br/>\u8BF7\u6307\u5B9A\u8981\u6D4B\u91CF\u7684\u7B2C\u4E00\u70B9\u7684\u5750\u6807\u4F4D\u7F6E":(a.feature.coordinates.length,l+="<br/>\u6309Alt\u952E\u53D6\u6355\u6349; Ctrl\u952E\u542F\u7528\u6B63\u4EA4; \u9000\u683C\u952E\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",l+=`<br/>\u5F53\u524D\u89D2\u5EA6: <span style="color: #ff0000">${Bt(o,a.feature.coordinates).angle}</span></span>`),F(l,o)},contextMenu:a=>{new u.default.ContextMenu({event:a.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u5220\u9664\u4E0A\u4E00\u4E2A\u70B9",onClick:()=>{o.fire("keyup",{keyCode:8})}},{label:"\u7ED3\u675F\u6D4B\u89D2\u5EA6",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});if(e.cancel)return F("",o),{cancel:!0,exit:t===!1};let r=u.default.randomColor(),i=new u.default.Polyline({data:e.features[0].geometry.coordinates,lineColor:r,lineWidth:2});return i.addTo(o),Pr(o,e.features[0].geometry.coordinates,r,i.sourceId||"",s),{polyline:i}},Fr=async(o,s)=>{for(;!((await Tr(o,s)).exit===!0||se!="measureAngle"););},Pr=(o,s,t,e,r)=>{if(s.length<3)return;let i=[],a=o.fromLngLat(s);s[1];let n=Bt(o,s);const l=u.default.getCirclePolygonCoordinates(a[1],a[1].distanceTo(a[0])/4,36,n.startAngle,n.endAngle,!1);let c=new u.default.Polyline({data:o.toLngLat(l),lineColor:t,lineWidth:2});c.addTo(o),i.push(c);let h=c.getData().features[0].geometry.coordinates,d=h[Math.ceil(h.length/2)],g=u.default.radiansToDegrees(-o.fromLngLat(d).angleTo(a[1]))+90;g>90?g+=180:g>270&&(g-=180);let f=new u.default.Text({text:n.angle,anchor:"center",rotation:g,offset:[0,0],style:{cursor:"pointer",opacity:.8,padding:"6px","border-radius":"12px","background-color":t,"border-width":0,"box-shadow":"0px 2px 6px 0px rgba(97,113,166,0.2)","text-align":"center","font-size":"14px",color:`#${t.substring(1).split("").map(p=>(15-parseInt(p,16)).toString(16)).join("")}`}});f.setLngLat(d).addTo(o),i.push(f);const y="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let m=document.createElement("div");m.className="marker",m.style.backgroundImage=`url(${y})`,m.style.width="20px",m.style.height="20px",m.style.backgroundSize="100%",m.style.cursor="pointer",m.addEventListener("click",function(p){o.removeSourceEx(e),i.forEach(b=>b.remove()),i=[]});let w=new u.default.Marker({element:m,anchor:"right"});w.setLngLat(s[1]).setOffset([-5,0]).addTo(o),i.push(w),Ke(r,s)},Bt=(o,s)=>{let t=o.fromLngLat(s);if(t.length<3)return{angle:0};let e=t[0].angleTo(t[1]),r=t[2].angleTo(t[1]),i=e-r,a=u.default.radiansToDegrees(i),n=!0;a<0&&(a=-a,n=!n),a>180&&(a=360-a,n=!n);let l=n?u.default.radiansToDegrees(r):u.default.radiansToDegrees(e),c=n?u.default.radiansToDegrees(e):u.default.radiansToDegrees(r);return l=l<0?360+l:l,c=c<0?360+c:c,c<l&&(c+=360),{angle:a.toFixed(2)+"\xB0",dir:n,startAngle:l,endAngle:c}},Er=async(o,s)=>{let t=!1,e=await u.default.Draw.actionDrawPoint(o,{api:{getSnapFeatures:s},updatecoordinate:r=>{if(!r.lnglat)return;t=!0;const i=o.fromLngLat(r.lnglat);let a=`<span style="color: #16417C">\u3010\u6D4B\u91CF\u5750\u6807\u3011\u5F53\u524D\u5750\u6807:<span style="color: #ff0000"> ${i.x.toFixed(2)}, ${i.y.toFixed(2)}</span></span>`;F(a,o)},contextMenu:r=>{new u.default.ContextMenu({event:r.event.originalEvent,theme:"dark",width:"250px",items:[{label:"\u786E\u8BA4",onClick:()=>{o.fire("keyup",{keyCode:13}),F("",o)}},{label:"\u53D6\u6D88",onClick:()=>{o.fire("keyup",{keyCode:27}),F("",o)}},{label:"\u7ED3\u675F\u6D4B\u5750\u6807",onClick:()=>{o.fire("keyup",{keyCode:27}),t=!1,F("",o)}}]})}});return e.cancel?(F("",o),{cancel:!0,exit:t===!1}):(Br(o,e.features[0].geometry.coordinates),{point:e})},Mr=async(o,s)=>{for(;!((await Er(o,s)).exit===!0||se!="measureCoordinate"););},Br=(o,s)=>{let t=[],e=o.fromLngLat(s),r=`X: ${e.x.toFixed(2)}, Y: ${e.y.toFixed(2)}`,i=Or(o,s,r);t.push(i);const a="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAbNJREFUWEftlrFOAkEQhv9Z4XgJOCrlTgp5ABOhMBoTCws7EzUaeAx5A0sDiYmFxpLGaAkU2KqFArHi4CU4cMccAQN6HHcIwZi7cnd25tt/5maHsOCPFhwfPoAnBarhQFIIccjAkV3qCMhKKct6q1tym1pPAHVVOWMg6+ScgKuYYR7PBaCmKmw5XgLiy4b5NhzkXVVWP4BXa00zTNcXc21oOR4AjAswaX9M2n4u1yLBIoiSbmV0Zcdc0pqd1HdbWwUWDuDqRjMy8lQDM4o54sYRoJcKq6qHclePKnuScQ0pd/RWt2ztVyOhLUFckIwTvWneDiLYnXdVA18O+r/dcNXXIsozCGsMzuhGJ98DUINpAuUAqmhGe33k/JjiG9g4K2ADUFdDOQan7QAIlI8Z7YwP4CvgK/C/FahFlQcwtm0bEeNFa5qJuSpgdT2AzkFyU290H3udMBzYgBD3gnAQa5iFuQJ4eZB6A8ovW/ETgARLmfIyaPZVSZIQRTBdas326Thwx7fAzRA6SREB2l0x2ndTAfTnwH0CrGk4PinY6D5VQHyhNcwbp3N/eyDxduPprH0FPgHEyH4wGIHUYwAAAABJRU5ErkJggg==";let n=document.createElement("div");n.className="marker",n.style.backgroundImage=`url(${a})`,n.style.width="20px",n.style.height="20px",n.style.backgroundSize="100%",n.style.cursor="pointer",n.addEventListener("click",function(c){t.forEach(h=>h.remove()),t=[]});let l=new u.default.Marker({element:n,anchor:"right"});l.setLngLat(s).setOffset([-5,0]).addTo(o),t.push(l)},Or=(o,s,t)=>{let e=document.createElement("div");e.className="marker",e.style.position="absolute";let r=document.createElement("div");r.style.backgroundImage='url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAB4AAAAAlCAYAAACj1PQVAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyhpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQ1IDc5LjE2MzQ5OSwgMjAxOC8wOC8xMy0xNjo0MDoyMiAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIDIwMTkgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTJFMTU1RjExN0UzMTFFOTg3RTBFODdGNTY0NThGQkUiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTJFMTU1RjIxN0UzMTFFOTg3RTBFODdGNTY0NThGQkUiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDoxMkUxNTVFRjE3RTMxMUU5ODdFMEU4N0Y1NjQ1OEZCRSIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDoxMkUxNTVGMDE3RTMxMUU5ODdFMEU4N0Y1NjQ1OEZCRSIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pj97JFoAAAV9SURBVHja7N1faJ1nHQfw33nzpuekaZfWNFmbLHXWdf7DWgvebF4M0SEZhTG8mKvFyzG9UJFKh9peVGnd0DkE/10Ic6s6BBEGbshggho3BVGnRnC2s1n/ras2J2uzc05PXp+3yZzSm7XJkvfi84HveZ9z3ve8F7/bL8/71oqiiMs8NhCLsCllfcpfAwAAAAAAAIDlsXM68jfgtl9K2Z3Sa8IAAAAAAAAAb7hjKW8uF9kS3/jdKR9PaZkxAAAAAAAAwPJa6h3A96X0pBxK+bLxAgAAAAAAACyfpSyAP5jy4ZQXUh747687p00ZAAAAAAAAYBlkS3if+xfW+1MuGC0AAAAAAADA8lqqAnh3yvaUZ1MeMlYAAAAAAACA5bcUBXBfyoGF9edSusYKAAAAAAAAsPyWogD+VMpYypMpTxgpAAAAAAAAwMpYbAG8IWVvylzKHuMEAAAAAAAAWDmLLYC/mDKQ8nDKH4wTAAAAAAAAYOUspgC+IeWelNmYL4IBAAAAAAAAWEGLKYAPpfSmfD1lyigBAAAAAAAAVtbVFsA3pdyR8lLMF8EAAAAAAAAArLCrKYBrKfcvHA+kNI0RAAAAAAAAYOVdTQFc7vwtdwA/l/ItIwQAAAAAAACohistgMt3/h5cWO9N6RghAAAAAAAAQDVcaQF8d8rWlImUnxgfAAAAAAAAQHVcSQF8Tcq+lCJlz8IRAAAAAAAAgIq4kgK4fOTzUMzv/J0wOgAAAAAAAIBqeb0F8FjKp2P+nb97jQ0AAAAAAACgel5vAXwgpS/l2ynPGRsAAAAAAABA9eSjd370sh+P7/q/r9tTdqc0Y74IBgAAAAAAAKCC8v9Zl7uB6yn9o4fHG+lYS2n/867Hv5bXivLcoZQzRgYAAAAAAABQTfnw5nvjxWMHe9N6cP+OyVtv2nj2ruFG6209WbGqM5c181rx9m5RO/ngn2/4zlf/tLV2fNfPCmMDAAAAAAAAqJ68LH+HGq2xRz7wu2+8a31zvCgiLs5FlC3vqp4YKS8638mzqZf7tqXlb1MuGBsAAAAAAABA9ZSPdh58tfyd7UScOh9xYjqLszNZlGVwN6U/71z7hR1/e/g9g9NbRg+P9xobAAAAAAAAQPVk+3ZMfujV8vf0TC3WXWzE9ZveHyNjt0UxOxCnp7NotiPWr2pfl67dk/6zxtgAAAAAAAAAqie7eePZXeVO33OtiOGsHqtvfjDi1scibnkkesafipHVI3HuQi3a3Yh3rpsZT/+5ZvTweM3oAAAAAAAAAKolH2q0byzf+dtuZ9G/8b0RW+587ezat0a84xPR+8z+aHU7MVDvbLhl05lrf3FyaGr08Hj5muA4/qMfmiIAAAAAAABABWS1KPJLTW75UR+8/Ir6uksvCi6K+a/Dfa26sQEAAAAAAABUT/ZyJz+Z19IiL6J7eiLi/NRrZ4tuxNEfRzvmorcnoj2XvfL41MZTMV8XAwAAAAAAAFAh2eS5tU9kWcRAo4ipC9MRP98ZMfnNiH/8IOLJO+LMC7+ORl83Gj0RR5r9z8x08nOhAAYAAAAAAAConPyzT2976H1D//7YYL21ZW5NN442n4/ep/ddeuxzK+air68bb2pEdCN75dEj192Xfp4xNgAAAAAAAIDqyWY6+akHnt16d7Oz6uRAPWJkoIi1azuxek0nhge6MdQXUatlrZ8+P/L5706+ZSLKXhgAAAAAAACAyik3+s5+/++bJ+751fbbfv/S+kc7c/l0WQSva0TUe2rtIzNrJr7yxxs/8pnfbPteurY5vPlej38GAAAAAAAAqKC8LHRfPHZw9penNvwl5ZP1nrmB268/MdafX+x96sTQ8aMz/f9K102ntJS/AAAAAAAAANX1HwEGAM75MhcANnAkAAAAAElFTkSuQmCC")',r.style.backgroundRepeat="no-repeat",r.style.height="37px",r.style.width="100px",r.style.position="absolute",r.style.left="-3px",r.style.bottom="-3px",r.style.right="0px",e.appendChild(r);let i=document.createElement("div");i.style.height="50px",i.style.width="350px",i.style.position="absolute",i.style.left="97px",i.style.top="-60px",i.style.border="solid 1px #8E0EFF",i.style.background="linear-gradient(#00ffff, #00ffff) left top,  linear-gradient(#00ffff, #00ffff) left top,     linear-gradient(#00ffff, #00ffff) right bottom,    linear-gradient(#00ffff, #00ffff) right bottom",i.style.backgroundRepeat="no-repeat",i.style.backgroundColor="rgba(87,255,255, 0.3)",i.style.backgroundSize="1px 6px, 6px 1px",i.style.fontSize="18px",i.style.color="#ffffff",i.innerHTML=`<div style='margin: 15px 5px 15px 5px'>${t}</div>`,e.appendChild(i);let a=new u.default.Marker({element:e,anchor:"bottom-left"});return a.setLngLat(s).addTo(o),a},Ot=(o,s)=>o.hasVectorLayer()?qe(o,s):Qe(o,s),Qe=(o,s)=>{s=s||{};const t=o.getService(),e=new Set;let r="",i={};const a=g=>{var f,y;i={backcolor:(f=t.currentMapParam())!=null&&f.darkMode?0:16777215,expression:r,...g,...s==null?void 0:s.style},o.updateStyle(t,{name:(y=s==null?void 0:s.styleName)!=null?y:"myCustomStyle_temp",...i})},n=g=>{let f="";return g!==void 0&&(f+=`gOutVisible:=${g?1:0};`),f},l=g=>(Array.isArray(g)||(g=[g]),`gInObjectId  in  '${g.join("||")}'`),c=async()=>{if(e.size==0)r="",await a();else{let g=l(Array.from(e)),f=n(!1);r=`if(${g}) {${f} } `,await a()}};return{addHideObjectIds:async(g,f,y)=>{y&&e.clear(),g.forEach(m=>e.add(m)),f||await c()},refresh:c,hideObjectIds:e,getClipBounds:()=>{var g,f;if((g=s==null?void 0:s.style)!=null&&g.clipbounds)return(f=s==null?void 0:s.style)==null?void 0:f.clipbounds}}},qe=(o,s)=>{const t=o.getService(),e=new Set,r=l=>(Array.isArray(l)||(l=[l]),["match",["id"],l,!0,!1]),i=async()=>{let l=t.vectorStyle().layers.map(h=>h.id),c=Array.from(e);o.setFilterEx(l,["!",r(c)])};return{addHideObjectIds:async(l,c,h)=>{h&&e.clear(),l.forEach(d=>e.add(d)),c||await i()},refresh:i,hideObjectIds:e,getClipBounds:()=>{var l,c;if((l=s==null?void 0:s.style)!=null&&l.clipbounds)return(c=s==null?void 0:s.style)==null?void 0:c.clipbounds}}};A.CacheDbStorage=Ie,A.LayerBase=k,A.MapApp=st,A.ProcessDataToFeatureCollection=ue,A.TsIndexDb=G,A.WmsOverlayMapType=Me,A.addExportRefInfoInText=ye,A.addFeaturesToDraw=N,A.addHighLightSourceLayer=Ue,A.base2OverlayCoordinate=rt,A.cacheStorage=Q,A.cad2webCoordinate=Ge,A.cancelDraw=lt,A.clearHighLightSourceLayer=ee,A.clearHighlight=me,A.convertArrayToGeoJson=ce,A.createGeomData=j,A.createHatch=St,A.createLineTypeCurve=Ct,A.createLineTypePolyline=Dt,A.createMapStyleLayerName=X,A.createOutSymbol=kt,A.createUpdateMapStyleObj=Ot,A.createUpdateMapStyleRasterObj=Qe,A.createUpdateMapStyleVectorObj=qe,A.default=Xe,A.deleteCadEntity=ot,A.deleteOrModifyCadEntity=we,A.drawArrow=vt,A.drawCircle=ht,A.drawEllipseArc=Lt,A.drawEllipseEdge=wt,A.drawEllipseFill=At,A.drawEllipseFillArc=bt,A.drawFillExrusion=ft,A.drawLineSting=ct,A.drawPoint=ut,A.drawPolygon=dt,A.drawRectangle=gt,A.drawSlantRectangle=yt,A.drawText=xt,A.evalDataConvert=Te,A.execProgram=De,A.exportDwg=it,A.gaodeProviderTiles=Pe,A.getEntityObjectId=le,A.getGeoJsonBounds=Le,A.getHighlightEntities=_e,A.getInstance=xe,A.getMapSnapPoints=Ae,A.getShardsTileUrl=ae,A.getTileShards=Ce,A.getTrackFeatureProperty=R,A.getWmsAutoCadBaseMapTileUrl=je,A.getWmsAutoWebBaseMapTileUrl=Ve,A.getWmsDirectTileUrl=Re,A.getWmsMapsBounds=Be,A.getWmsParamTileUrl=Ne,A.getWmsTileUrl=He,A.initIndexDb=ke,A.interactiveCreateGeom=re,A.isAlphanumeric=ne,A.isTrackFeature=$,A.isWebBaseMap=O,A.loadDataToDraw=nt,A.loadWebMap=Ee,A.modifyCadEntity=at,A.osmProviderTiles=et,A.overlay2BaseCoordinate=We,A.polygonToPolyline=te,A.providerLayers=Se,A.queryMapData=q,A.requestChangeData=W,A.runMeasureCmd=Pt,A.selectFeatures=Ze,A.selectRotate=mt,A.setFeatureProperty=M,A.setLayerOpacity=Tt,A.setLayerToLowest=Ft,A.setTrackFeatureProperty=ze,A.sleep=oe,A.switchCadLayers=It,A.switchVectorLayers=Je,A.tiandituProviderTiles=Fe,A.toBezierCurve=pt,A.toMapLayer=P,A.toProperties=V,A.transformGeoJsonData=H,A.web2cadCoordinate=tt,Object.defineProperties(A,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=vjcommon.min.js.map
